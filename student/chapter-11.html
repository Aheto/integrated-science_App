<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Describe the physical characteristics of plant nutrients and how they are applied">
  <title>Mini OpenStax ‚Äî Describe the physical characteristics of plant nutrients and how they are applied</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Describe the physical characteristics of plant nutrients and how they are applied</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.2.3.1.2</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <!-- === REPLACE THIS SECTION PER LESSON === -->
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <li>Describe the physical form (solid, powder, liquid, granules) of common organic and inorganic nutrients.</li>
          <li>Explain how the physical characteristics affect how each nutrient is applied to plants.</li>
          <li>Demonstrate safe and effective application methods in a school garden or model plot.</li>
          <li>Work in groups to plan and present a nutrient application guide for local crops.</li>
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <span class="word-item">Granular</span>
          <span class="word-item">Powder</span>
          <span class="word-item">Liquid fertilizer</span>
          <span class="word-item">Compost</span>
          <span class="word-item">Manure</span>
          <span class="word-item">Top dressing</span>
          <span class="word-item">Incorporation</span>
          <span class="word-item">Application rate</span>
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò How Nutrients Look and How We Use Them</h2>
        <p>Not all plant nutrients look or behave the same. Their **physical form** determines how‚Äîand when‚Äîwe apply them to crops.</p>

        <h3>üîç Physical Characteristics & Application Methods</h3>
        <table>
          <thead>
            <tr><th>Nutrient Type</th><th>Physical Form</th><th>How It‚Äôs Applied</th></tr>
          </thead>
          <tbody>
            <tr><td><strong>Compost</strong></td><td>Dark, crumbly solid with earthy smell</td><td>Mixed into soil before planting (incorporation)</td></tr>
            <tr><td><strong>Animal manure</strong></td><td>Moist clumps or dried pellets</td><td>Applied weeks before planting to allow decomposition</td></tr>
            <tr><td><strong>NPK fertilizer</strong></td><td>Coloured granules or powder</td><td>Sprinkled near plant roots (top dressing) or mixed in soil</td></tr>
            <tr><td><strong>Urea</strong></td><td>White crystalline granules</td><td>Lightly buried near roots; never on leaves (burns them!)</td></tr>
            <tr><td><strong>Liquid fertilizer</strong></td><td>Water-soluble powder or liquid</td><td>Diluted in water and poured at base of plant</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Why shouldn‚Äôt you sprinkle urea directly on plant leaves? What might happen?
        </blockquote>

        <h3>‚úÖ Exemplar Activity: School Garden Demo</h3>
        <p>In your school garden or a model plot:</p>
        <ol>
          <li><strong>Observe</strong>: Feel compost (crumbly), NPK (hard granules), manure (moist).</li>
          <li><strong>Apply safely</strong>:
            <ul>
              <li>Wear gloves when handling manure.</li>
              <li>Use measuring spoons for chemical fertilizers‚Äînever guess!</li>
              <li>Water after applying dry nutrients to help dissolve them.</li>
            </ul>
          </li>
          <li><strong>Record</strong>: Note which method works best for tomatoes vs. maize.</li>
        </ol>

        <h3>üå± Group Work: Create an Application Guide</h3>
        <p>With your group, design a simple poster for farmers or classmates:</p>
        <ul>
          <li>‚ÄúHow to Apply Compost to Okra‚Äù</li>
          <li>‚ÄúUsing NPK Safely on Maize‚Äù</li>
          <li>‚ÄúWhy Timing Matters for Manure‚Äù</li>
        </ul>
        <p>Include drawings, safety tips, and dosage (e.g., ‚Äú1 handful per plant‚Äù).</p>

        <h3>‚ö†Ô∏è Safety First!</h3>
        <ul>
          <li>Always wash hands after handling fertilizers.</li>
          <li>Store chemicals in labeled, sealed containers away from children.</li>
          <li>Never mix unknown substances‚Äîsome combinations release toxic gas!</li>
        </ul>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <ol>
            <li>Describe the physical form of compost and NPK fertilizer.</li>
            <li>Why is manure applied weeks before planting?</li>
            <li>Demonstrate how to safely apply urea to a potted plant.</li>
            <li>Create a mini-guide: ‚ÄúHow to Use Liquid Fertilizer on Pepper Plants.‚Äù</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In the next unit, we‚Äôll explore energy‚Äîhow it changes form, moves through systems, and powers everything from cooking to electricity.</p>
      </div>
      <!-- === END REPLACE SECTION === -->

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <!-- FOOTER -->
      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const currentChapter = 11;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Describe the physical characteristics of plant nutrients and how they are applied",
        loTags: ["B7/JHS1.2.3.1.2"],
        objectives: [
          "Describe the physical form (solid, powder, liquid, granules) of common organic and inorganic nutrients.",
          "Explain how the physical characteristics affect how each nutrient is applied to plants.",
          "Demonstrate safe and effective application methods in a school garden or model plot.",
          "Work in groups to plan and present a nutrient application guide for local crops."
        ],
        words: [
          "Granular", "Powder", "Liquid fertilizer", "Compost",
          "Manure", "Top dressing", "Incorporation", "Application rate"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Describe the physical form of compost and NPK fertilizer.</li>
            <li>Why is manure applied weeks before planting?</li>
            <li>Demonstrate how to safely apply urea to a potted plant.</li>
            <li>Create a mini-guide: ‚ÄúHow to Use Liquid Fertilizer on Pepper Plants.‚Äù</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In the next unit, we‚Äôll explore energy‚Äîhow it changes form, moves through systems, and powers everything from cooking to electricity.",
        assessmentItems: [
          { id: "1", prompt: "What is the typical physical form of compost?", options: [
            {id:"a",text:"White crystals",is_correct:false},
            {id:"b",text:"Dark, crumbly solid",is_correct:true},
            {id:"c",text:"Clear liquid",is_correct:false},
            {id:"d",text:"Gas",is_correct:false}
          ]},
          { id: "2", prompt: "How is NPK fertilizer usually applied to growing crops?", options: [
            {id:"a",text:"Sprayed on leaves",is_correct:false},
            {id:"b",text:"Mixed into drinking water",is_correct:false},
            {id:"c",text:"Sprinkled near roots (top dressing)",is_correct:true},
            {id:"d",text:"Burned as fuel",is_correct:false}
          ]},
          { id: "3", prompt: "Why should manure be applied weeks before planting?", options: [
            {id:"a",text:"It needs time to decompose and release nutrients safely",is_correct:true},
            {id:"b",text:"It kills seeds instantly",is_correct:false},
            {id:"c",text:"It attracts pests only after two weeks",is_correct:false},
            {id:"d",text:"It evaporates quickly",is_correct:false}
          ]},
          { id: "4", prompt: "What happens if urea is placed directly on plant leaves?", options: [
            {id:"a",text:"Leaves grow faster",is_correct:false},
            {id:"b",text:"Leaves may burn due to high nitrogen concentration",is_correct:true},
            {id:"c",text:"Flowers bloom immediately",is_correct:false},
            {id:"d",text:"Roots shrink",is_correct:false}
          ]},
          { id: "5", prompt: "How is liquid fertilizer typically used?", options: [
            {id:"a",text:"Poured undiluted on soil",is_correct:false},
            {id:"b",text:"Diluted in water and applied at the base of plants",is_correct:true},
            {id:"c",text:"Inhaled by plants",is_correct:false},
            {id:"d",text:"Mixed with compost only",is_correct:false}
          ]},
          { id: "6", prompt: "What does 'top dressing' mean?", options: [
            {id:"a",text:"Adding nutrients to the soil surface near plant roots during growth",is_correct:true},
            {id:"b",text:"Painting plants with colour",is_correct:false},
            {id:"c",text:"Covering plants with cloth",is_correct:false},
            {id:"d",text:"Harvesting the top leaves",is_correct:false}
          ]},
          { id: "7", prompt: "Which safety practice is essential when handling chemical fertilizers?", options: [
            {id:"a",text:"Wear gloves and wash hands after use",is_correct:true},
            {id:"b",text:"Taste a small amount to test quality",is_correct:false},
            {id:"c",text:"Store in open bowls",is_correct:false},
            {id:"d",text:"Mix with any household chemical",is_correct:false}
          ]},
          { id: "8", prompt: "What is 'incorporation' in farming?", options: [
            {id:"a",text:"Mixing nutrients into the soil before planting",is_correct:true},
            {id:"b",text:"Selling crops online",is_correct:false},
            {id:"c",text:"Watering plants daily",is_correct:false},
            {id:"d",text:"Pruning branches",is_correct:false}
          ]},
          { id: "9", prompt: "Which core competency is developed during group nutrient application planning?", options: [
            {id:"a",text:"Communication and Collaboration",is_correct:true},
            {id:"b",text:"Musical talent",is_correct:false},
            {id:"c",text:"Athletic ability",is_correct:false},
            {id:"d",text:"Cooking skill",is_correct:false}
          ]},
          { id: "10", prompt: "Why is it important to measure fertilizer amounts?", options: [
            {id:"a",text:"To avoid waste, save money, and prevent plant damage",is_correct:true},
            {id:"b",text:"To make the soil colourful",is_correct:false},
            {id:"c",text:"To attract more insects",is_correct:false},
            {id:"d",text:"To increase packaging sales",is_correct:false}
          ]},
          { id: "11", prompt: "What is the physical form of urea?", options: [
            {id:"a",text:"Black powder",is_correct:false},
            {id:"b",text:"White crystalline granules",is_correct:true},
            {id:"c",text:"Sticky liquid",is_correct:false},
            {id:"d",text:"Foam",is_correct:false}
          ]},
          { id: "12", prompt: "How can students demonstrate practical nutrient application?", options: [
            {id:"a",text:"By using a school garden or model plot",is_correct:true},
            {id:"b",text:"By watching TV only",is_correct:false},
            {id:"c",text:"By memorising definitions",is_correct:false},
            {id:"d",text:"By skipping class",is_correct:false}
          ]},
          { id: "13", prompt: "What should you do after applying dry fertilizer?", options: [
            {id:"a",text:"Water the plants to help dissolve nutrients",is_correct:true},
            {id:"b",text:"Cover plants with plastic",is_correct:false},
            {id:"c",text:"Leave it dry for a week",is_correct:false},
            {id:"d",text:"Burn the field",is_correct:false}
          ]},
          { id: "14", prompt: "Which statement about compost is TRUE?", options: [
            {id:"a",text:"It is synthetic and expensive",is_correct:false},
            {id:"b",text:"It improves soil structure and releases nutrients slowly",is_correct:true},
            {id:"c",text:"It harms earthworms",is_correct:false},
            {id:"d",text:"It must be imported",is_correct:false}
          ]},
          { id: "15", prompt: "Why create a nutrient application guide?", options: [
            {id:"a",text:"To share clear, safe instructions with farmers or classmates",is_correct:true},
            {id:"b",text:"To replace teachers",is_correct:false},
            {id:"c",text:"To sell online",is_correct:false},
            {id:"d",text:"To confuse others",is_correct:false}
          ]},
          { id: "16", prompt: "What is an 'application rate'?", options: [
            {id:"a",text:"How fast a tractor moves",is_correct:false},
            {id:"b",text:"The amount of nutrient applied per plant or area",is_correct:true},
            {id:"c",text:"The cost of fertilizer",is_correct:false},
            {id:"d",text:"The colour of the nutrient",is_correct:false}
          ]},
          { id: "17", prompt: "Which nutrient is best applied by incorporation before planting?", options: [
            {id:"a",text:"Compost",is_correct:true},
            {id:"b",text:"Urea",is_correct:false},
            {id:"c",text:"Liquid fertilizer",is_correct:false},
            {id:"d",text:"NPK top dressing",is_correct:false}
          ]},
          { id: "18", prompt: "What is a risk of guessing fertilizer amounts?", options: [
            {id:"a",text:"Healthier plants",is_correct:false},
            {id:"b",text:"Nutrient burn, wasted money, or pollution",is_correct:true},
            {id:"c",text:"Better taste",is_correct:false},
            {id:"d",text:"Faster growth always",is_correct:false}
          ]},
          { id: "19", prompt: "How does physical form affect nutrient use?", options: [
            {id:"a",text:"Granules are sprinkled; liquids are diluted; solids are mixed in",is_correct:true},
            {id:"b",text:"All forms are used the same way",is_correct:false},
            {id:"c",text:"Only colour matters",is_correct:false},
            {id:"d",text:"Form has no impact",is_correct:false}
          ]},
          { id: "20", prompt: "What conclusion can you draw about nutrient application?", options: [
            {id:"a",text:"Safe, measured application based on physical form leads to healthy crops and soil",is_correct:true},
            {id:"b",text:"More fertilizer is always better",is_correct:false},
            {id:"c",text:"Application method doesn‚Äôt matter",is_correct:false},
            {id:"d",text:"Only chemicals work",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
