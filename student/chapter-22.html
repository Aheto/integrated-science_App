<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Introduction to Farming Systems">
  <title>Mini OpenStax ‚Äî Introduction to Farming Systems</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Introduction to Farming Systems</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.3.4.1</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <li>Define what a farming system is.</li>
          <li>Identify five common farming systems used in Ghana and beyond.</li>
          <li>Describe the basic practices of each system using everyday examples.</li>
          <li>Recognize how farming systems connect to culture, food security, and sustainability.</li>
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <span class="word-item">Farming System</span>
          <span class="word-item">Land Rotation</span>
          <span class="word-item">Crop Rotation</span>
          <span class="word-item">Mixed Cropping</span>
          <span class="word-item">Mixed Farming</span>
          <span class="word-item">Organic Farming</span>
          <span class="word-item">Soil Fertility</span>
          <span class="word-item">Sustainability</span>
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò What Is a Farming System?</h2>
        <p>A <strong>farming system</strong> is the way a farmer uses land, crops, animals, tools, and knowledge to grow food or raise livestock. It includes decisions about <em>what</em> to grow, <em>how</em> to grow it, and <em>why</em> certain methods are chosen‚Äîoften based on climate, soil, tradition, or market needs.</p>

        <p>In Ghana and many parts of Africa, farmers use different systems depending on their goals, resources, and environment. Let‚Äôs explore five major ones:</p>

        <table>
          <thead>
            <tr>
              <th>System</th>
              <th>What It Means</th>
              <th>Real-Life Example</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Land Rotation</strong></td>
              <td>Farmers move from one plot of land to another after a few years, letting the old plot rest and regain fertility naturally.</td>
              <td>A farmer in Northern Ghana farms Plot A for 3 years, then abandons it for 5 years while farming Plot B.</td>
            </tr>
            <tr>
              <td><strong>Crop Rotation</strong></td>
              <td>Different crops are grown in a planned sequence on the same land over seasons to improve soil health.</td>
              <td>Maize ‚Üí Cowpea ‚Üí Cassava on the same field over three planting seasons.</td>
            </tr>
            <tr>
              <td><strong>Mixed Cropping</strong></td>
              <td>Two or more crops are grown together on the same field at the same time.</td>
              <td>Planting maize and beans side-by-side in the same field during the rainy season.</td>
            </tr>
            <tr>
              <td><strong>Mixed Farming</strong></td>
              <td>Combining crop production with animal rearing on the same farm.</td>
              <td>A family grows yam and keeps goats‚Äîthe goat manure fertilizes the yam field.</td>
            </tr>
            <tr>
              <td><strong>Organic Farming</strong></td>
              <td>Farming without synthetic chemicals; uses natural compost, pest control, and seeds.</td>
              <td>A farmer uses kitchen waste compost and neem leaves to protect tomatoes from insects.</td>
            </tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Imagine you inherit a small piece of farmland near Kumasi. Which farming system would you choose if your goals were: (1) feeding your family, (2) protecting the soil, and (3) avoiding expensive chemicals? Why?
        </blockquote>

        <h3>‚úÖ Exemplar Activity</h3>
        <p><strong>‚ÄúDraw Your Ideal Farm‚Äù</strong>: On paper, sketch a simple layout of a farm using one of the five systems. Label crops, animals (if any), and show how the system helps the soil or saves money. Share with a partner and explain your choices.</p>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <ol>
            <li>What is the main difference between <em>land rotation</em> and <em>crop rotation</em>?</li>
            <li>Why might a farmer plant maize and beans together?</li>
            <li>How does mixed farming support sustainability?</li>
            <li>Name one benefit of organic farming for human health.</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 23, you‚Äôll compare these farming systems in detail‚Äîexamining their strengths, weaknesses, and suitability for different regions of Ghana.</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = (() => {
        const path = window.location.pathname;
        const match = path.match(/chapter-(\d+)\.html$/);
        return match ? parseInt(match[1], 10) : 0;
      })();

      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Introduction to Farming Systems",
        loTags: ["B7/JHS1.3.4.1"],
        objectives: [
          "Define what a farming system is.",
          "Identify five common farming systems used in Ghana and beyond.",
          "Describe the basic practices of each system using everyday examples.",
          "Recognize how farming systems connect to culture, food security, and sustainability."
        ],
        words: [
          "Farming System", "Land Rotation", "Crop Rotation", "Mixed Cropping",
          "Mixed Farming", "Organic Farming", "Soil Fertility", "Sustainability"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>What is the main difference between <em>land rotation</em> and <em>crop rotation</em>?</li>
            <li>Why might a farmer plant maize and beans together?</li>
            <li>How does mixed farming support sustainability?</li>
            <li>Name one benefit of organic farming for human health.</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In Lesson 23, you‚Äôll compare these farming systems in detail‚Äîexamining their strengths, weaknesses, and suitability for different regions of Ghana.",
        assessmentItems: [
          { id: "1", prompt: "Which farming system involves moving to a new plot of land after several years?", options: [
            {id:"a",text:"Crop Rotation",is_correct:false},
            {id:"b",text:"Land Rotation",is_correct:true},
            {id:"c",text:"Mixed Cropping",is_correct:false},
            {id:"d",text:"Organic Farming",is_correct:false}
          ]},
          { id: "2", prompt: "Growing maize and cowpea on the same field at the same time is an example of:", options: [
            {id:"a",text:"Land Rotation",is_correct:false},
            {id:"b",text:"Crop Rotation",is_correct:false},
            {id:"c",text:"Mixed Cropping",is_correct:true},
            {id:"d",text:"Mixed Farming",is_correct:false}
          ]},
          { id: "3", prompt: "Which system combines crop growing and animal rearing?", options: [
            {id:"a",text:"Mixed Farming",is_correct:true},
            {id:"b",text:"Organic Farming",is_correct:false},
            {id:"c",text:"Land Rotation",is_correct:false},
            {id:"d",text:"Crop Rotation",is_correct:false}
          ]},
          { id: "4", prompt: "What is a key feature of organic farming?", options: [
            {id:"a",text:"Use of synthetic pesticides",is_correct:false},
            {id:"b",text:"Reliance on chemical fertilizers",is_correct:false},
            {id:"c",text:"Use of natural inputs only",is_correct:true},
            {id:"d",text:"Monoculture planting",is_correct:false}
          ]},
          { id: "5", prompt: "Why do farmers rotate crops like maize and legumes?", options: [
            {id:"a",text:"To make harvesting easier",is_correct:false},
            {id:"b",text:"To reduce soil fertility",is_correct:false},
            {id:"c",text:"To restore nitrogen in the soil",is_correct:true},
            {id:"d",text:"To increase land size",is_correct:false}
          ]},
          { id: "6", prompt: "Which system allows land to recover by leaving it unused for years?", options: [
            {id:"a",text:"Crop Rotation",is_correct:false},
            {id:"b",text:"Land Rotation",is_correct:true},
            {id:"c",text:"Mixed Cropping",is_correct:false},
            {id:"d",text:"Organic Farming",is_correct:false}
          ]},
          { id: "7", prompt: "A farmer uses goat manure to fertilize her yam field. This is part of:", options: [
            {id:"a",text:"Land Rotation",is_correct:false},
            {id:"b",text:"Mixed Farming",is_correct:true},
            {id:"c",text:"Crop Rotation",is_correct:false},
            {id:"d",text:"Monoculture",is_correct:false}
          ]},
          { id: "8", prompt: "Which practice helps prevent pests without chemicals?", options: [
            {id:"a",text:"Using neem leaves",is_correct:true},
            {id:"b",text:"Spraying glyphosate",is_correct:false},
            {id:"c",text:"Burning crop residue",is_correct:false},
            {id:"d",text:"Over-tilling",is_correct:false}
          ]},
          { id: "9", prompt: "What does 'sustainability' mean in farming?", options: [
            {id:"a",text:"Maximizing short-term profit",is_correct:false},
            {id:"b",text:"Using resources so future generations can also farm",is_correct:true},
            {id:"c",text:"Growing only one crop forever",is_correct:false},
            {id:"d",text:"Importing all seeds from abroad",is_correct:false}
          ]},
          { id: "10", prompt: "Which system is most likely used by a smallholder farmer with limited land?", options: [
            {id:"a",text:"Land Rotation",is_correct:false},
            {id:"b",text:"Mixed Cropping",is_correct:true},
            {id:"c",text:"Large-scale monoculture",is_correct:false},
            {id:"d",text:"Industrial livestock",is_correct:false}
          ]},
          { id: "11", prompt: "In crop rotation, why follow maize with beans?", options: [
            {id:"a",text:"Beans fix nitrogen that maize depletes",is_correct:true},
            {id:"b",text:"Maize needs shade from beans",is_correct:false},
            {id:"c",text:"Beans grow faster than maize",is_correct:false},
            {id:"d",text:"It reduces labor",is_correct:false}
          ]},
          { id: "12", prompt: "Which system is least dependent on external inputs like chemicals?", options: [
            {id:"a",text:"Conventional farming",is_correct:false},
            {id:"b",text:"Organic Farming",is_correct:true},
            {id:"c",text:"Hydroponics",is_correct:false},
            {id:"d",text:"Greenhouse farming",is_correct:false}
          ]},
          { id: "13", prompt: "What is a risk of land rotation in densely populated areas?", options: [
            {id:"a",text:"Too much forest growth",is_correct:false},
            {id:"b",text:"Not enough land to leave fallow",is_correct:true},
            {id:"c",text:"Excess rainfall",is_correct:false},
            {id:"d",text:"High cost of seeds",is_correct:false}
          ]},
          { id: "14", prompt: "Which farming system supports biodiversity the most?", options: [
            {id:"a",text:"Monoculture",is_correct:false},
            {id:"b",text:"Mixed Cropping",is_correct:true},
            {id:"c",text:"Chemical-intensive farming",is_correct:false},
            {id:"d",text:"Desert farming",is_correct:false}
          ]},
          { id: "15", prompt: "Organic farming contributes to:", options: [
            {id:"a",text:"Soil degradation",is_correct:false},
            {id:"b",text:"Water pollution",is_correct:false},
            {id:"c",text:"Healthier food and cleaner environment",is_correct:true},
            {id:"d",text:"Higher pesticide residues",is_correct:false}
          ]},
          { id: "16", prompt: "Which is NOT a farming system listed in the NaCCA curriculum?", options: [
            {id:"a",text:"Mixed Farming",is_correct:false},
            {id:"b",text:"Hydroponics",is_correct:true},
            {id:"c",text:"Crop Rotation",is_correct:false},
            {id:"d",text:"Organic Farming",is_correct:false}
          ]},
          { id: "17", prompt: "Cultural identity in farming may be shown through:", options: [
            {id:"a",text:"Only using imported seeds",is_correct:false},
            {id:"b",text:"Abandoning traditional methods",is_correct:false},
            {id:"c",text:"Practicing indigenous systems like mixed cropping",is_correct:true},
            {id:"d",text:"Ignoring local climate",is_correct:false}
          ]},
          { id: "18", prompt: "Which system helps break pest cycles naturally?", options: [
            {id:"a",text:"Planting the same crop every year",is_correct:false},
            {id:"b",text:"Crop Rotation",is_correct:true},
            {id:"c",text:"Overgrazing",is_correct:false},
            {id:"d",text:"Burning fields yearly",is_correct:false}
          ]},
          { id: "19", prompt: "A key goal of sustainable farming is to:", options: [
            {id:"a",text:"Deplete soil quickly",is_correct:false},
            {id:"b",text:"Maximize single-season yield at all costs",is_correct:false},
            {id:"c",text:"Maintain long-term land productivity",is_correct:true},
            {id:"d",text:"Replace all manual labor with machines",is_correct:false}
          ]},
          { id: "20", prompt: "Which statement best defines a farming system?", options: [
            {id:"a",text:"A single crop grown for export",is_correct:false},
            {id:"b",text:"The combination of crops, animals, methods, and goals used on a farm",is_correct:true},
            {id:"c",text:"A government policy on agriculture",is_correct:false},
            {id:"d",text:"A type of tractor",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
