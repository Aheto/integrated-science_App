<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Merits and Demerits of Farming Systems">
  <title>Mini OpenStax ‚Äî Merits and Demerits of Farming Systems</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .debate-card {
      background: #fcf8e3;
      padding: 1rem;
      margin: 1rem 0;
      border-left: 4px solid #8a6d3b;
      border-radius: 4px;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Merits and Demerits of Farming Systems</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.3.4.1.3</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <li>Evaluate the advantages and disadvantages of each farming system.</li>
          <li>Debate which system is most suitable for different contexts in Ghana.</li>
          <li>Reflect on cultural, economic, and environmental trade-offs.</li>
          <li>Form a reasoned personal stance on sustainable farming futures.</li>
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <span class="word-item">Merit</span>
          <span class="word-item">Demerit</span>
          <span class="word-item">Trade-off</span>
          <span class="word-item">Sustainability</span>
          <span class="word-item">Food Security</span>
          <span class="word-item">Cultural Practice</span>
          <span class="word-item">Economic Viability</span>
          <span class="word-item">Environmental Impact</span>
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò Weighing the Pros and Cons</h2>
        <p>Every farming system has strengths and weaknesses. The ‚Äúbest‚Äù system depends on land size, climate, market access, tradition, and goals like profit, food security, or environmental care.</p>

        <table>
          <thead>
            <tr>
              <th>System</th>
              <th>Merits (Pros)</th>
              <th>Demerits (Cons)</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td><strong>Land Rotation</strong></td>
              <td>‚Ä¢ Natural soil recovery<br>‚Ä¢ Low cost<br>‚Ä¢ Preserves indigenous knowledge</td>
              <td>‚Ä¢ Requires large land area<br>‚Ä¢ Not viable near cities<br>‚Ä¢ Can encourage deforestation</td>
            </tr>
            <tr>
              <td><strong>Crop Rotation</strong></td>
              <td>‚Ä¢ Boosts long-term yield<br>‚Ä¢ Reduces pests & diseases<br>‚Ä¢ Improves soil fertility</td>
              <td>‚Ä¢ Needs planning & knowledge<br>‚Ä¢ Less flexible for quick cash crops</td>
            </tr>
            <tr>
              <td><strong>Mixed Cropping</strong></td>
              <td>‚Ä¢ Reduces crop failure risk<br>‚Ä¢ Saves space<br>‚Ä¢ Natural pest control</td>
              <td>‚Ä¢ Hard to mechanise<br>‚Ä¢ Complex harvesting & storage</td>
            </tr>
            <tr>
              <td><strong>Mixed Farming</strong></td>
              <td>‚Ä¢ Diversifies income<br>‚Ä¢ Waste becomes resource (manure)<br>‚Ä¢ Supports household nutrition</td>
              <td>‚Ä¢ More labour-intensive<br>‚Ä¢ Requires animal care skills</td>
            </tr>
            <tr>
              <td><strong>Organic Farming</strong></td>
              <td>‚Ä¢ Healthier food<br>‚Ä¢ Eco-friendly<br>‚Ä¢ Premium market prices</td>
              <td>‚Ä¢ Lower short-term yields<br>‚Ä¢ High labour demand<br>‚Ä¢ Certification costs</td>
            </tr>
          </tbody>
        </table>

        <div class="debate-card">
          <strong>Real Debate Prompt:</strong> ‚ÄúShould Ghanaian smallholder farmers adopt Organic Farming even if it means lower yields?‚Äù<br>
          ‚Üí Consider health, environment, income, and cultural values.
        </div>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Your family owns 1 acre of land near Accra. You want to feed your household, earn some income, protect the soil, and avoid expensive inputs. Which system would you choose‚Äîand what compromises are you making?
        </blockquote>

        <h3>‚úÖ Exemplar Activity</h3>
        <p><strong>‚ÄúFarming Futures Forum‚Äù</strong>: In groups, assign roles (farmer, environmentalist, economist, youth). Debate: ‚ÄúWhich farming system should Ghana promote for the next generation?‚Äù Use evidence from the table and your community experience.</p>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <ol>
            <li>Why might Mixed Farming be more resilient than monoculture?</li>
            <li>What is one environmental demerit of Land Rotation today?</li>
            <li>How does Organic Farming support cultural identity and global markets at the same time?</li>
            <li>If a farmer prioritises short-term profit over sustainability, which system might they choose‚Äîand why?</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 26, we begin a new unit: <strong>Forces and Energy</strong>. You‚Äôll explore forms of energy like kinetic, potential, solar, and electrical‚Äîand how they power our daily lives.</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = (() => {
        const path = window.location.pathname;
        const match = path.match(/chapter-(\d+)\.html$/);
        return match ? parseInt(match[1], 10) : 0;
      })();

      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Merits and Demerits of Farming Systems",
        loTags: ["B7/JHS1.3.4.1.3"],
        objectives: [
          "Evaluate the advantages and disadvantages of each farming system.",
          "Debate which system is most suitable for different contexts in Ghana.",
          "Reflect on cultural, economic, and environmental trade-offs.",
          "Form a reasoned personal stance on sustainable farming futures."
        ],
        words: [
          "Merit", "Demerit", "Trade-off", "Sustainability",
          "Food Security", "Cultural Practice", "Economic Viability", "Environmental Impact"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Why might Mixed Farming be more resilient than monoculture?</li>
            <li>What is one environmental demerit of Land Rotation today?</li>
            <li>How does Organic Farming support cultural identity and global markets at the same time?</li>
            <li>If a farmer prioritises short-term profit over sustainability, which system might they choose‚Äîand why?</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In Lesson 26, we begin a new unit: <strong>Forces and Energy</strong>. You‚Äôll explore forms of energy like kinetic, potential, solar, and electrical‚Äîand how they power our daily lives.",
        assessmentItems: [
          { id: "1", prompt: "Which system best supports long-term soil health without chemicals?", options: [
            {id:"a",text:"Land Rotation",is_correct:false},
            {id:"b",text:"Crop Rotation",is_correct:true},
            {id:"c",text:"Monoculture",is_correct:false},
            {id:"d",text:"Chemical-dependent farming",is_correct:false}
          ]},
          { id: "2", prompt: "A major demerit of Organic Farming is:", options: [
            {id:"a",text:"High chemical use",is_correct:false},
            {id:"b",text:"Lower short-term yields",is_correct:true},
            {id:"c",text:"Easy certification",is_correct:false},
            {id:"d",text:"Low labour need",is_correct:false}
          ]},
          { id: "3", prompt: "Which system is most threatened by urban land pressure?", options: [
            {id:"a",text:"Mixed Cropping",is_correct:false},
            {id:"b",text:"Land Rotation",is_correct:true},
            {id:"c",text:"Crop Rotation",is_correct:false},
            {id:"d",text:"Organic Farming",is_correct:false}
          ]},
          { id: "4", prompt: "Mixed Farming enhances resilience because it:", options: [
            {id:"a",text:"Relies on one income source",is_correct:false},
            {id:"b",text:"Diversifies food and income sources",is_correct:true},
            {id:"c",text:"Uses only crops",is_correct:false},
            {id:"d",text:"Avoids animals",is_correct:false}
          ]},
          { id: "5", prompt: "Which system aligns with both cultural identity and eco-tourism markets?", options: [
            {id:"a",text:"Industrial monoculture",is_correct:false},
            {id:"b",text:"Traditional Organic Farming",is_correct:true},
            {id:"c",text:"Heavy pesticide use",is_correct:false},
            {id:"d",text:"Deforestation-based farming",is_correct:false}
          ]},
          { id: "6", prompt: "A trade-off in Mixed Cropping is:", options: [
            {id:"a",text:"Higher mechanisation ease",is_correct:false},
            {id:"b",text:"Reduced risk but harder harvesting",is_correct:true},
            {id:"c",text:"Lower biodiversity",is_correct:false},
            {id:"d",text:"Increased chemical need",is_correct:false}
          ]},
          { id: "7", prompt: "Which system contributes most to deforestation when land is scarce?", options: [
            {id:"a",text:"Crop Rotation",is_correct:false},
            {id:"b",text:"Land Rotation",is_correct:true},
            {id:"c",text:"Mixed Farming",is_correct:false},
            {id:"d",text:"Organic Farming",is_correct:false}
          ]},
          { id: "8", prompt: "Food security is best supported by:", options: [
            {id:"a",text:"Growing only cash crops",is_correct:false},
            {id:"b",text:"Diversified systems like Mixed Farming",is_correct:true},
            {id:"c",text:"Abandoning traditional methods",is_correct:false},
            {id:"d",text:"Importing all food",is_correct:false}
          ]},
          { id: "9", prompt: "Which system requires the most specialised knowledge?", options: [
            {id:"a",text:"Land Rotation",is_correct:false},
            {id:"b",text:"Organic Farming",is_correct:true},
            {id:"c",text:"Simple monoculture",is_correct:false},
            {id:"d",text:"Burning fields yearly",is_correct:false}
          ]},
          { id: "10", prompt: "Economic viability in farming means:", options: [
            {id:"a",text:"Only focusing on tradition",is_correct:false},
            {id:"b",text:"Balancing cost, yield, and market value sustainably",is_correct:true},
            {id:"c",text:"Maximising chemical use",is_correct:false},
            {id:"d",text:"Ignoring soil health",is_correct:false}
          ]},
          { id: "11", prompt: "Which system is least adaptable to climate shocks?", options: [
            {id:"a",text:"Monoculture",is_correct:true},
            {id:"b",text:"Mixed Cropping",is_correct:false},
            {id:"c",text:"Crop Rotation",is_correct:false},
            {id:"d",text:"Mixed Farming",is_correct:false}
          ]},
          { id: "12", prompt: "Cultural identity in farming is shown by:", options: [
            {id:"a",text:"Rejecting all local knowledge",is_correct:false},
            {id:"b",text:"Practicing and adapting indigenous systems",is_correct:true},
            {id:"c",text:"Only using foreign seeds",is_correct:false},
            {id:"d",text:"Avoiding community practices",is_correct:false}
          ]},
          { id: "13", prompt: "A merit of Crop Rotation is that it:", options: [
            {id:"a",text:"Increases pest buildup",is_correct:false},
            {id:"b",text:"Naturally restores soil nitrogen (with legumes)",is_correct:true},
            {id:"c",text:"Requires more chemicals",is_correct:false},
            {id:"d",text:"Reduces biodiversity",is_correct:false}
          ]},
          { id: "14", prompt: "Which system offers premium pricing opportunities?", options: [
            {id:"a",text:"Conventional maize farming",is_correct:false},
            {id:"b",text:"Organic vegetable farming",is_correct:true},
            {id:"c",text:"Land Rotation",is_correct:false},
            {id:"d",text:"Monoculture cassava",is_correct:false}
          ]},
          { id: "15", prompt: "Environmental impact is lowest in:", options: [
            {id:"a",text:"Chemical-intensive farming",is_correct:false},
            {id:"b",text:"Organic and Mixed systems",is_correct:true},
            {id:"c",text:"Deforestation-based farming",is_correct:false},
            {id:"d",text:"Industrial livestock",is_correct:false}
          ]},
          { id: "16", prompt: "Which statement reflects a balanced view?", options: [
            {id:"a",text:"One system fits all farmers everywhere",is_correct:false},
            {id:"b",text:"Context determines the best system",is_correct:true},
            {id:"c",text:"Traditional systems are always outdated",is_correct:false},
            {id:"d",text:"Modern = better",is_correct:false}
          ]},
          { id: "17", prompt: "Sustainability in farming includes:", options: [
            {id:"a",text:"Only short-term profit",is_correct:false},
            {id:"b",text:"Soil health, biodiversity, and future generations",is_correct:true},
            {id:"c",text:"Maximising chemical inputs",is_correct:false},
            {id:"d",text:"Ignoring water conservation",is_correct:false}
          ]},
          { id: "18", prompt: "Which system is most feasible for a backyard urban farmer?", options: [
            {id:"a",text:"Land Rotation",is_correct:false},
            {id:"b",text:"Mixed Cropping or Organic",is_correct:true},
            {id:"c",text:"Large-scale mixed farming",is_correct:false},
            {id:"d",text:"Industrial feedlots",is_correct:false}
          ]},
          { id: "19", prompt: "A key reason to debate farming systems is to:", options: [
            {id:"a",text:"Impose one method on all",is_correct:false},
            {id:"b",text:"Understand trade-offs and make informed choices",is_correct:true},
            {id:"c",text:"Ignore local context",is_correct:false},
            {id:"d",text:"Promote only imported models",is_correct:false}
          ]},
          { id: "20", prompt: "Which system best embodies the idea: 'Waste not, want not'?", options: [
            {id:"a",text:"Monoculture",is_correct:false},
            {id:"b",text:"Mixed Farming",is_correct:true},
            {id:"c",text:"Land Rotation",is_correct:false},
            {id:"d",text:"Chemical farming",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
