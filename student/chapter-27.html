<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Daily Applications of Energy">
  <title>Mini OpenStax ‚Äî Daily Applications of Energy</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Daily Applications of Energy</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.1.1.2</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò Energy All Around You</h2>
        <p>Energy isn‚Äôt just a science concept‚Äîit powers your world! From cooking breakfast to charging your phone, every action involves energy transformation.</p>

        <h3>Matching Energy to Everyday Devices</h3>
        <table>
          <thead>
            <tr><th>Appliance / Activity</th><th>Input Energy</th><th>Output Energy</th></tr>
          </thead>
          <tbody>
            <tr><td>Electric kettle</td><td>Electrical</td><td>Thermal (heat)</td></tr>
            <tr><td>Solar lamp</td><td>Solar</td><td>Light (+ some heat)</td></tr>
            <tr><td>Drumming</td><td>Kinetic (arm motion)</td><td>Sound</td></tr>
            <tr><td>Eating yam</td><td>Chemical (food)</td><td>Kinetic (movement) + Thermal (body heat)</td></tr>
            <tr><td>Wind-up toy</td><td>Potential (spring)</td><td>Kinetic</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Imagine your classroom during a power outage. Which activities become impossible? Which can still happen using other forms of energy (like sunlight, muscle power, or stored chemical energy)? How does this show energy‚Äôs role in modern life?
        </blockquote>

        <div class="activity-card">
          <h3>‚úÖ Exemplar Activity (NaCCA-aligned)</h3>
          <p><strong>‚ÄúEnergy Mapping Challenge‚Äù</strong>: Create a simple chart with three columns: <em>Location (Home / School / Market)</em>, <em>Device or Action</em>, and <em>Energy Transformation</em>. Fill in at least 6 examples. Bonus: Identify one inefficient device (e.g., old bulb wasting heat) and suggest a better alternative.
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 28, you‚Äôll learn how to calculate Potential Energy (PE = mgh) and Kinetic Energy (KE = ¬Ωmv¬≤)‚Äîand solve real problems like ‚ÄúHow much energy does a falling mango have?‚Äù</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 27;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Daily Applications of Energy",
        loTags: ["B7/JHS1.4.1.1.2"],
        objectives: [
          "Identify how different forms of energy are used in homes, schools, and communities.",
          "Match everyday devices to their input and output energy forms.",
          "Explain how mass, height, and speed affect potential and kinetic energy in real life.",
          "Evaluate energy efficiency in common appliances."
        ],
        words: [
          "Appliance", "Transformation", "Efficiency", "Input", "Output",
          "Mechanical", "Thermal", "Electrical", "Community", "Factors"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Name two devices at home that convert electrical energy into thermal energy.</li>
            <li>Why does a heavier object at the same height have more potential energy?</li>
            <li>How does speed affect the kinetic energy of a moving bicycle?</li>
            <li>Give one example of wasted energy (e.g., heat from a light bulb). How could it be reduced?</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In Lesson 28, you‚Äôll learn how to calculate Potential Energy (PE = mgh) and Kinetic Energy (KE = ¬Ωmv¬≤)‚Äîand solve real problems like ‚ÄúHow much energy does a falling mango have?‚Äù",
        assessmentItems: [
          { id: "1", prompt: "Which device converts electrical energy mainly into light?", options: [
            {id:"a",text:"Electric stove",is_correct:false},
            {id:"b",text:"LED bulb",is_correct:true},
            {id:"c",text:"Blender",is_correct:false},
            {id:"d",text:"Fan",is_correct:false}
          ]},
          { id: "2", prompt: "Cooking with firewood involves:", options: [
            {id:"a",text:"Chemical ‚Üí Thermal + Light",is_correct:true},
            {id:"b",text:"Electrical ‚Üí Sound",is_correct:false},
            {id:"c",text:"Kinetic ‚Üí Potential",is_correct:false},
            {id:"d",text:"Solar ‚Üí Chemical",is_correct:false}
          ]},
          { id: "3", prompt: "A hydroelectric dam uses:", options: [
            {id:"a",text:"Solar energy",is_correct:false},
            {id:"b",text:"Nuclear fission",is_correct:false},
            {id:"c",text:"Gravitational potential energy of water",is_correct:true},
            {id:"d",text:"Wind energy",is_correct:false}
          ]},
          { id: "4", prompt: "Which factor increases gravitational potential energy?", options: [
            {id:"a",text:"Lower height",is_correct:false},
            {id:"b",text:"Less mass",is_correct:false},
            {id:"c",text:"Greater height",is_correct:true},
            {id:"d",text:"Slower speed",is_correct:false}
          ]},
          { id: "5", prompt: "Kinetic energy increases most when:", options: [
            {id:"a",text:"Mass doubles",is_correct:false},
            {id:"b",text:"Speed doubles",is_correct:true},
            {id:"c",text:"Height increases",is_correct:false},
            {id:"d",text:"Temperature drops",is_correct:false}
          ]},
          { id: "6", prompt: "A ringing mobile phone transforms:", options: [
            {id:"a",text:"Chemical ‚Üí Electrical ‚Üí Sound + Light",is_correct:true},
            {id:"b",text:"Solar ‚Üí Thermal",is_correct:false},
            {id:"c",text:"Potential ‚Üí Nuclear",is_correct:false},
            {id:"d",text:"Kinetic ‚Üí Chemical",is_correct:false}
          ]},
          { id: "7", prompt: "Which is an inefficient use of energy?", options: [
            {id:"a",text:"Using solar panels",is_correct:false},
            {id:"b",text:"Incandescent bulb producing lots of heat",is_correct:true},
            {id:"c",text:"LED lighting",is_correct:false},
            {id:"d",text:"Hand-crank radio",is_correct:false}
          ]},
          { id: "8", prompt: "Walking to school uses energy from:", options: [
            {id:"a",text:"Petrol",is_correct:false},
            {id:"b",text:"Chemical energy in food",is_correct:true},
            {id:"c",text:"Solar panels",is_correct:false},
            {id:"d",text:"Batteries",is_correct:false}
          ]},
          { id: "9", prompt: "In a school bell, energy flows as:", options: [
            {id:"a",text:"Electrical ‚Üí Sound",is_correct:true},
            {id:"b",text:"Light ‚Üí Thermal",is_correct:false},
            {id:"c",text:"Potential ‚Üí Chemical",is_correct:false},
            {id:"d",text:"Kinetic ‚Üí Nuclear",is_correct:false}
          ]},
          { id: "10", prompt: "Which has more kinetic energy?", options: [
            {id:"a",text:"A slow-moving truck",is_correct:false},
            {id:"b",text:"A fast-moving bicycle",is_correct:false},
            {id:"c",text:"A stationary car",is_correct:false},
            {id:"d",text:"A fast-moving truck",is_correct:true}
          ]},
          { id: "11", prompt: "A raised hammer has:", options: [
            {id:"a",text:"Kinetic energy",is_correct:false},
            {id:"b",text:"Thermal energy",is_correct:false},
            {id:"c",text:"Gravitational potential energy",is_correct:true},
            {id:"d",text:"Sound energy",is_correct:false}
          ]},
          { id: "12", prompt: "Energy from the sun reaches Earth as:", options: [
            {id:"a",text:"Chemical energy",is_correct:false},
            {id:"b",text:"Nuclear energy",is_correct:false},
            {id:"c",text:"Solar (radiant) energy",is_correct:true},
            {id:"d",text:"Electrical energy",is_correct:false}
          ]},
          { id: "13", prompt: "Which activity uses human kinetic energy?", options: [
            {id:"a",text:"Charging a phone",is_correct:false},
            {id:"b",text:"Pedaling a bicycle",is_correct:true},
            {id:"c",text:"Watching TV",is_correct:false},
            {id:"d",text:"Using a microwave",is_correct:false}
          ]},
          { id: "14", prompt: "What affects potential energy the most in daily life?", options: [
            {id:"a",text:"Color of object",is_correct:false},
            {id:"b",text:"Height above ground",is_correct:true},
            {id:"c",text:"Temperature",is_correct:false},
            {id:"d",text:"Sound level",is_correct:false}
          ]},
          { id: "15", prompt: "A campfire mainly produces:", options: [
            {id:"a",text:"Light and sound",is_correct:false},
            {id:"b",text:"Thermal and light",is_correct:true},
            {id:"c",text:"Electrical and kinetic",is_correct:false},
            {id:"d",text:"Chemical and nuclear",is_correct:false}
          ]},
          { id: "16", prompt: "Which is a renewable energy source used in Ghana?", options: [
            {id:"a",text:"Coal",is_correct:false},
            {id:"b",text:"Solar",is_correct:true},
            {id:"c",text:"Petrol",is_correct:false},
            {id:"d",text:"Natural gas",is_correct:false}
          ]},
          { id: "17", prompt: "When you drop a ball, its energy changes from:", options: [
            {id:"a",text:"Kinetic to potential",is_correct:false},
            {id:"b",text:"Potential to kinetic",is_correct:true},
            {id:"c",text:"Chemical to thermal",is_correct:false},
            {id:"d",text:"Electrical to sound",is_correct:false}
          ]},
          { id: "18", prompt: "An electric fan converts:", options: [
            {id:"a",text:"Electrical ‚Üí Kinetic + Sound",is_correct:true},
            {id:"b",text:"Solar ‚Üí Light",is_correct:false},
            {id:"c",text:"Chemical ‚Üí Thermal",is_correct:false},
            {id:"d",text:"Potential ‚Üí Nuclear",is_correct:false}
          ]},
          { id: "19", prompt: "Which statement is TRUE about energy use?", options: [
            {id:"a",text:"All energy conversions are 100% efficient",is_correct:false},
            {id:"b",text:"Some energy is always 'wasted' as heat",is_correct:true},
            {id:"c",text:"Energy disappears after use",is_correct:false},
            {id:"d",text:"Only machines use energy",is_correct:false}
          ]},
          { id: "20", prompt: "To reduce energy waste at home, you should:", options: [
            {id:"a",text:"Leave lights on all day",is_correct:false},
            {id:"b",text:"Use energy-efficient bulbs",is_correct:true},
            {id:"c",text:"Boil excess water",is_correct:false},
            {id:"d",text:"Charge phones overnight",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
