<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Calculating Potential and Kinetic Energy">
  <title>Mini OpenStax ‚Äî Calculating Potential and Kinetic Energy</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
    .formula {
      background: #e8f5e9;
      padding: 0.75rem;
      border-radius: 6px;
      font-family: monospace;
      font-size: 1.1rem;
      text-align: center;
      margin: 1rem 0;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Calculating Potential and Kinetic Energy</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.1.1 (Math Focus)</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò The Math Behind Energy</h2>
        <p>Now that you know energy comes in many forms, let‚Äôs calculate it! Two key types‚Äî<strong>potential</strong> and <strong>kinetic</strong>‚Äîcan be measured using simple formulas.</p>

        <div class="formula">
          <strong>Potential Energy (PE)</strong> = mass √ó gravity √ó height<br>
          ‚Üí <code>PE = mgh</code><br>
          (m in kg, g = 10 m/s¬≤, h in meters ‚Üí PE in joules)
        </div>

        <div class="formula">
          <strong>Kinetic Energy (KE)</strong> = ¬Ω √ó mass √ó (speed)¬≤<br>
          ‚Üí <code>KE = ¬Ωmv¬≤</code><br>
          (m in kg, v in m/s ‚Üí KE in joules)
        </div>

        <h3>Real-World Examples</h3>
        <table>
          <thead>
            <tr><th>Scenario</th><th>Calculation</th></tr>
          </thead>
          <tbody>
            <tr><td>A 2 kg textbook on a 1.5 m shelf</td><td>PE = 2 √ó 10 √ó 1.5 = <strong>30 J</strong></td></tr>
            <tr><td>A 60 kg student running at 3 m/s</td><td>KE = 0.5 √ó 60 √ó (3)¬≤ = <strong>270 J</strong></td></tr>
            <tr><td>A 0.5 kg mango falling from 4 m</td><td>PE = 0.5 √ó 10 √ó 4 = <strong>20 J</strong> (just before falling)</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: If two objects have the same mass but one is twice as high, which has more PE? If two bikes have the same mass but one moves twice as fast, which has more KE? Why does speed affect KE more than mass?
        </blockquote>

        <div class="activity-card">
          <h3>‚úÖ Exemplar Activity (NaCCA-aligned)</h3>
          <p><strong>‚ÄúEnergy Detective: Quantitative Edition‚Äù</strong>: Choose 3 real objects (e.g., water tank, moving car, falling fruit). Estimate their mass and height/speed. Calculate PE or KE using the formulas. Compare your results‚Äîwhat surprises you?
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 29, you‚Äôll explore how heat moves through solids, liquids, and gases‚Äîand why a metal spoon gets hot faster than a wooden one!</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 28;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Calculating Potential and Kinetic Energy",
        loTags: ["B7/JHS1.4.1.1 (Math Focus)"],
        objectives: [
          "Use the formula PE = mgh to calculate gravitational potential energy.",
          "Use the formula KE = ¬Ωmv¬≤ to calculate kinetic energy.",
          "Solve real-world problems involving mechanical energy.",
          "Explain why speed has a greater effect on KE than mass."
        ],
        words: [
          "Formula", "Joule", "Mass", "Gravity", "Height",
          "Velocity", "Potential", "Kinetic", "Mechanical", "Calculate"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Calculate the PE of a 5 kg bag lifted to 2 m height. (Use g = 10 m/s¬≤)</li>
            <li>Find the KE of a 1000 kg car moving at 10 m/s.</li>
            <li>Why is KE proportional to v¬≤ and not just v?</li>
            <li>If you double the height of an object, what happens to its PE?</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In Lesson 29, you‚Äôll explore how heat moves through solids, liquids, and gases‚Äîand why a metal spoon gets hot faster than a wooden one!",
        assessmentItems: [
          { id: "1", prompt: "What is the unit of energy?", options: [
            {id:"a",text:"Watt",is_correct:false},
            {id:"b",text:"Newton",is_correct:false},
            {id:"c",text:"Joule",is_correct:true},
            {id:"d",text:"Pascal",is_correct:false}
          ]},
          { id: "2", prompt: "PE = mgh. What does 'g' represent?", options: [
            {id:"a",text:"Grams",is_correct:false},
            {id:"b",text:"Gravity (‚âà10 m/s¬≤)",is_correct:true},
            {id:"c",text:"Gas",is_correct:false},
            {id:"d",text:"Gigajoule",is_correct:false}
          ]},
          { id: "3", prompt: "A 3 kg object at 4 m height has PE = ?", options: [
            {id:"a",text:"12 J",is_correct:false},
            {id:"b",text:"70 J",is_correct:false},
            {id:"c",text:"120 J",is_correct:true},
            {id:"d",text:"30 J",is_correct:false}
          ]},
          { id: "4", prompt: "KE = ¬Ωmv¬≤. If mass = 4 kg and v = 5 m/s, KE = ?", options: [
            {id:"a",text:"25 J",is_correct:false},
            {id:"b",text:"50 J",is_correct:true},
            {id:"c",text:"100 J",is_correct:false},
            {id:"d",text:"20 J",is_correct:false}
          ]},
          { id: "5", prompt: "Which increases KE more: doubling mass or doubling speed?", options: [
            {id:"a",text:"Doubling mass",is_correct:false},
            {id:"b",text:"Doubling speed",is_correct:true},
            {id:"c",text:"Same effect",is_correct:false},
            {id:"d",text:"Neither",is_correct:false}
          ]},
          { id: "6", prompt: "A book on a table has zero PE if:", options: [
            {id:"a",text:"It‚Äôs not moving",is_correct:false},
            {id:"b",text:"Height is measured from the table",is_correct:true},
            {id:"c",text:"It‚Äôs light",is_correct:false},
            {id:"d",text:"Room is cold",is_correct:false}
          ]},
          { id: "7", prompt: "Mechanical energy = ?", options: [
            {id:"a",text:"PE √ó KE",is_correct:false},
            {id:"b",text:"PE + KE",is_correct:true},
            {id:"c",text:"PE ‚Äì KE",is_correct:false},
            {id:"d",text:"KE / PE",is_correct:false}
          ]},
          { id: "8", prompt: "A 60 kg runner at 4 m/s has KE ‚âà ?", options: [
            {id:"a",text:"240 J",is_correct:false},
            {id:"b",text:"480 J",is_correct:true},
            {id:"c",text:"960 J",is_correct:false},
            {id:"d",text:"120 J",is_correct:false}
          ]},
          { id: "9", prompt: "If height triples, PE:", options: [
            {id:"a",text:"Triples",is_correct:true},
            {id:"b",text:"Doubles",is_correct:false},
            {id:"c",text:"Quadruples",is_correct:false},
            {id:"d",text:"Halves",is_correct:false}
          ]},
          { id: "10", prompt: "Which has more KE: 2 kg at 3 m/s or 3 kg at 2 m/s?", options: [
            {id:"a",text:"2 kg @ 3 m/s (9 J)",is_correct:true},
            {id:"b",text:"3 kg @ 2 m/s (6 J)",is_correct:false},
            {id:"c",text:"Same",is_correct:false},
            {id:"d",text:"Not enough info",is_correct:false}
          ]},
          { id: "11", prompt: "Gravitational PE depends on all EXCEPT:", options: [
            {id:"a",text:"Mass",is_correct:false},
            {id:"b",text:"Height",is_correct:false},
            {id:"c",text:"Speed",is_correct:true},
            {id:"d",text:"Gravity",is_correct:false}
          ]},
          { id: "12", prompt: "KE depends on:", options: [
            {id:"a",text:"Mass and height",is_correct:false},
            {id:"b",text:"Mass and speed",is_correct:true},
            {id:"c",text:"Height and gravity",is_correct:false},
            {id:"d",text:"Color and texture",is_correct:false}
          ]},
          { id: "13", prompt: "A 1 kg stone dropped from 10 m has PE = ?", options: [
            {id:"a",text:"10 J",is_correct:false},
            {id:"b",text:"50 J",is_correct:false},
            {id:"c",text:"100 J",is_correct:true},
            {id:"d",text:"1 J",is_correct:false}
          ]},
          { id: "14", prompt: "At the top of a hill, a cyclist has mostly:", options: [
            {id:"a",text:"KE",is_correct:false},
            {id:"b",text:"PE",is_correct:true},
            {id:"c",text:"Thermal",is_correct:false},
            {id:"d",text:"Sound",is_correct:false}
          ]},
          { id: "15", prompt: "At the bottom of a slide, a child has mostly:", options: [
            {id:"a",text:"PE",is_correct:false},
            {id:"b",text:"KE",is_correct:true},
            {id:"c",text:"Chemical",is_correct:false},
            {id:"d",text:"Nuclear",is_correct:false}
          ]},
          { id: "16", prompt: "If v = 0, then KE = ?", options: [
            {id:"a",text:"mgh",is_correct:false},
            {id:"b",text:"¬Ωm",is_correct:false},
            {id:"c",text:"0",is_correct:true},
            {id:"d",text:"Undefined",is_correct:false}
          ]},
          { id: "17", prompt: "Which object has the most PE?", options: [
            {id:"a",text:"1 kg at 5 m",is_correct:false},
            {id:"b",text:"2 kg at 3 m",is_correct:true},
            {id:"c",text:"3 kg at 1 m",is_correct:false},
            {id:"d",text:"0.5 kg at 10 m",is_correct:false}
          ]},
          { id: "18", prompt: "Energy cannot be:", options: [
            {id:"a",text:"Transformed",is_correct:false},
            {id:"b",text:"Measured",is_correct:false},
            {id:"c",text:"Created or destroyed",is_correct:true},
            {id:"d",text:"Used",is_correct:false}
          ]},
          { id: "19", prompt: "In free fall, total mechanical energy:", options: [
            {id:"a",text:"Increases",is_correct:false},
            {id:"b",text:"Decreases",is_correct:false},
            {id:"c",text:"Stays constant (ignoring air resistance)",is_correct:true},
            {id:"d",text:"Becomes zero",is_correct:false}
          ]},
          { id: "20", prompt: "Why use g = 10 instead of 9.8 in school problems?", options: [
            {id:"a",text:"It‚Äôs more accurate",is_correct:false},
            {id:"b",text:"Simplifies calculation",is_correct:true},
            {id:"c",text:"Gravity changes daily",is_correct:false},
            {id:"d",text:"Required by law",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
