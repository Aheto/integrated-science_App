<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Heat Transfer in Solids, Liquids, and Gases">
  <title>Mini OpenStax ‚Äî Heat Transfer in Solids, Liquids, and Gases</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1.2rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
    .mode-box {
      background: #f0f7f4;
      padding: 0.75rem;
      margin: 0.75rem 0;
      border-radius: 6px;
      border-left: 3px solid var(--green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Heat Transfer in Solids, Liquids, and Gases</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.1.2.1</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò How Heat Moves</h2>
        <p>Heat always flows from hotter objects to cooler ones‚Äîbut it moves in different ways depending on the material. There are **three main methods**:</p>

        <div class="mode-box">
          <strong>1. Conduction</strong><br>
          ‚Üí Heat moves through direct contact in solids.<br>
          ‚Üí Metals (like iron pots) conduct heat well; plastics and wood do not.<br>
          ‚Üí Example: A metal spoon in hot soup gets hot at the handle.
        </div>

        <div class="mode-box">
          <strong>2. Convection</strong><br>
          ‚Üí Heat moves through liquids and gases by currents.<br>
          ‚Üí Warm fluid rises, cool fluid sinks ‚Üí creates a cycle.<br>
          ‚Üí Example: Boiling water ‚Äî hot water rises, cooler water sinks.
        </div>

        <div class="mode-box">
          <strong>3. Radiation</strong><br>
          ‚Üí Heat travels as invisible waves (no medium needed!).<br>
          ‚Üí Works through empty space.<br>
          ‚Üí Example: Sun warming your skin; heat from a fire.
        </div>

        <table>
          <thead>
            <tr><th>Medium</th><th>Best Method</th><th>Why?</th></tr>
          </thead>
          <tbody>
            <tr><td>Metal rod</td><td>Conduction</td><td>Tightly packed particles transfer vibrations quickly.</td></tr>
            <tr><td>Water in pot</td><td>Convection</td><td>Fluid can flow and circulate heat.</td></tr>
            <tr><td>Air in room</td><td>Convection + Radiation</td><td>Air currents + infrared waves from heaters.</td></tr>
            <tr><td>Vacuum (space)</td><td>Radiation only</td><td>No particles for conduction/convection.</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Why do cooks use wooden spoons instead of metal ones when stirring hot soup? If you stand near a fire but don‚Äôt touch it, how do you still feel warm? Which method is at work in each case?
        </blockquote>

        <div class="activity-card">
          <h3>‚úÖ Exemplar Activity (NaCCA-aligned)</h3>
          <p><strong>‚ÄúHeat Transfer Detective‚Äù</strong>: Gather 4 items: metal spoon, plastic spoon, glass of water, and a candle.<br>
          1. Place both spoons in hot water for 1 minute. Which feels hotter? Why?<br>
          2. Light the candle. Hold your hand above it (not touching!) ‚Äî feel convection.<br>
          3. Hold your hand beside it ‚Äî feel radiation.<br>
          Record your observations and explain using the three methods.
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 30, you‚Äôll explore how light travels in straight lines‚Äîand how mirrors, lenses, and rainbows reveal its amazing properties!</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 29;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Heat Transfer in Solids, Liquids, and Gases",
        loTags: ["B7/JHS1.4.1.2.1"],
        objectives: [
          "Identify the three methods of heat transfer: conduction, convection, and radiation.",
          "Explain how heat moves differently through solids, liquids, gases, and vacuum.",
          "Relate heat transfer methods to everyday examples in Ghanaian homes and communities.",
          "Conduct simple experiments to observe conduction and convection."
        ],
        words: [
          "Conduction", "Convection", "Radiation", "Medium", "Insulator",
          "Conductor", "Current", "Infrared", "Thermal", "Transfer"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Why does a metal pot handle get hot faster than a wooden one?</li>
            <li>Describe how convection works when boiling water.</li>
            <li>How does the Sun‚Äôs heat reach Earth through space?</li>
            <li>Give one example of each heat transfer method in daily life.</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In Lesson 30, you‚Äôll explore how light travels in straight lines‚Äîand how mirrors, lenses, and rainbows reveal its amazing properties!",
        assessmentItems: [
          { id: "1", prompt: "Which method transfers heat through direct contact?", options: [
            {id:"a",text:"Radiation",is_correct:false},
            {id:"b",text:"Convection",is_correct:false},
            {id:"c",text:"Conduction",is_correct:true},
            {id:"d",text:"Reflection",is_correct:false}
          ]},
          { id: "2", prompt: "Heat from the Sun reaches Earth by:", options: [
            {id:"a",text:"Conduction",is_correct:false},
            {id:"b",text:"Convection",is_correct:false},
            {id:"c",text:"Radiation",is_correct:true},
            {id:"d",text:"Insulation",is_correct:false}
          ]},
          { id: "3", prompt: "Which material is a good conductor of heat?", options: [
            {id:"a",text:"Wood",is_correct:false},
            {id:"b",text:"Plastic",is_correct:false},
            {id:"c",text:"Copper",is_correct:true},
            {id:"d",text:"Rubber",is_correct:false}
          ]},
          { id: "4", prompt: "In boiling water, hot water rises and cool water sinks. This is:", options: [
            {id:"a",text:"Conduction",is_correct:false},
            {id:"b",text:"Convection",is_correct:true},
            {id:"c",text:"Radiation",is_correct:false},
            {id:"d",text:"Dispersion",is_correct:false}
          ]},
          { id: "5", prompt: "Which is NOT a method of heat transfer?", options: [
            {id:"a",text:"Conduction",is_correct:false},
            {id:"b",text:"Convection",is_correct:false},
            {id:"c",text:"Radiation",is_correct:false},
            {id:"d",text:"Refraction",is_correct:true}
          ]},
          { id: "6", prompt: "A thermos flask reduces heat loss by minimizing:", options: [
            {id:"a",text:"Only conduction",is_correct:false},
            {id:"b",text:"Only radiation",is_correct:false},
            {id:"c",text:"All three methods",is_correct:true},
            {id:"d",text:"Only convection",is_correct:false}
          ]},
          { id: "7", prompt: "Why are cooking pots made of metal?", options: [
            {id:"a",text:"Metals are cheap",is_correct:false},
            {id:"b",text:"Metals conduct heat well",is_correct:true},
            {id:"c",text:"Metals look shiny",is_correct:false},
            {id:"d",text:"Metals are light",is_correct:false}
          ]},
          { id: "8", prompt: "Feeling warmth near a fire without touching it is due to:", options: [
            {id:"a",text:"Conduction",is_correct:false},
            {id:"b",text:"Convection",is_correct:false},
            {id:"c",text:"Radiation",is_correct:true},
            {id:"d",text:"Insulation",is_correct:false}
          ]},
          { id: "9", prompt: "Which is a good insulator?", options: [
            {id:"a",text:"Aluminum",is_correct:false},
            {id:"b",text:"Iron",is_correct:false},
            {id:"c",text:"Styrofoam",is_correct:true},
            {id:"d",text:"Steel",is_correct:false}
          ]},
          { id: "10", prompt: "Heat cannot travel by conduction in:", options: [
            {id:"a",text:"Solids",is_correct:false},
            {id:"b",text:"Liquids",is_correct:false},
            {id:"c",text:"Gases",is_correct:false},
            {id:"d",text:"Vacuum",is_correct:true}
          ]},
          { id: "11", prompt: "Warm air rising in a room is an example of:", options: [
            {id:"a",text:"Conduction",is_correct:false},
            {id:"b",text:"Convection",is_correct:true},
            {id:"c",text:"Radiation",is_correct:false},
            {id:"d",text:"Reflection",is_correct:false}
          ]},
          { id: "12", prompt: "Handles of cooking pans are often made of plastic because plastic:", options: [
            {id:"a",text:"Is a good conductor",is_correct:false},
            {id:"b",text:"Is a poor conductor (insulator)",is_correct:true},
            {id:"c",text:"Melts easily",is_correct:false},
            {id:"d",text:"Looks colorful",is_correct:false}
          ]},
          { id: "13", prompt: "Which method works in space?", options: [
            {id:"a",text:"Conduction",is_correct:false},
            {id:"b",text:"Convection",is_correct:false},
            {id:"c",text:"Radiation",is_correct:true},
            {id:"d",text:"All of them",is_correct:false}
          ]},
          { id: "14", prompt: "When you touch a hot stove, heat transfers by:", options: [
            {id:"a",text:"Radiation",is_correct:false},
            {id:"b",text:"Convection",is_correct:false},
            {id:"c",text:"Conduction",is_correct:true},
            {id:"d",text:"Dispersion",is_correct:false}
          ]},
          { id: "15", prompt: "Sea breezes are caused by:", options: [
            {id:"a",text:"Conduction in sand",is_correct:false},
            {id:"b",text:"Convection in air",is_correct:true},
            {id:"c",text:"Radiation from waves",is_correct:false},
            {id:"d",text:"Reflection of sunlight",is_correct:false}
          ]},
          { id: "16", prompt: "Which material would you use to keep tea hot longer?", options: [
            {id:"a",text:"Metal cup",is_correct:false},
            {id:"b",text:"Glass cup",is_correct:false},
            {id:"c",text:"Cup with foam sleeve",is_correct:true},
            {id:"d",text:"Thin ceramic cup",is_correct:false}
          ]},
          { id: "17", prompt: "In solids, heat is mainly transferred by:", options: [
            {id:"a",text:"Vibrating particles",is_correct:true},
            {id:"b",text:"Moving fluids",is_correct:false},
            {id:"c",text:"Electromagnetic waves",is_correct:false},
            {id:"d",text:"Chemical reactions",is_correct:false}
          ]},
          { id: "18", prompt: "Dark clothes feel hotter in sunlight because they:", options: [
            {id:"a",text:"Absorb more radiation",is_correct:true},
            {id:"b",text:"Reflect more light",is_correct:false},
            {id:"c",text:"Conduct less heat",is_correct:false},
            {id:"d",text:"Trap convection currents",is_correct:false}
          ]},
          { id: "19", prompt: "Which statement is TRUE?", options: [
            {id:"a",text:"Convection occurs in solids",is_correct:false},
            {id:"b",text:"Radiation needs a medium",is_correct:false},
            {id:"c",text:"Conduction works best in metals",is_correct:true},
            {id:"d",text:"Heat flows from cold to hot",is_correct:false}
          ]},
          { id: "20", prompt: "To reduce heat loss in buildings, people use:", options: [
            {id:"a",text:"Metal walls",is_correct:false},
            {id:"b",text:"Double-glazed windows and insulation",is_correct:true},
            {id:"c",text:"Black roofs",is_correct:false},
            {id:"d",text:"Open windows",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
