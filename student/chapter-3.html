<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Explain the effects of heating and cooling on materials">
  <title>Mini OpenStax ‚Äî Explain the effects of heating and cooling on materials</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Explain the effects of heating and cooling on materials</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.1.1.1.4</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <!-- === REPLACE THIS SECTION PER LESSON === -->
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <li>Observe and describe how heating and cooling cause materials to change state (e.g., melting, freezing, evaporation, condensation).</li>
          <li>Explain why some changes are reversible and others are not.</li>
          <li>Apply knowledge of heating/cooling to real-life situations like cooking, food preservation, and weather.</li>
          <li>Record examples of state changes in your home or community.</li>
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <span class="word-item">Melting</span>
          <span class="word-item">Freezing</span>
          <span class="word-item">Evaporation</span>
          <span class="word-item">Condensation</span>
          <span class="word-item">Boiling</span>
          <span class="word-item">Reversible</span>
          <span class="word-item">Heat energy</span>
          <span class="word-item">State change</span>
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò How Heating and Cooling Change Materials</h2>
        <p>When we add or remove <strong>heat energy</strong>, materials can change from one state to another. These are called <em>changes of state</em>‚Äîand they happen all around you in Ghana!</p>

        <h3>üî• Heating Causes State Changes</h3>
        <ul>
          <li><strong>Melting</strong>: Solid ‚Üí Liquid (e.g., ice ‚Üí water)</li>
          <li><strong>Evaporation</strong>: Liquid ‚Üí Gas (e.g., wet clothes drying in sun)</li>
          <li><strong>Boiling</strong>: Rapid evaporation (e.g., water bubbling at 100¬∞C)</li>
        </ul>

        <h3>‚ùÑÔ∏è Cooling Causes State Changes</h3>
        <ul>
          <li><strong>Freezing</strong>: Liquid ‚Üí Solid (e.g., water ‚Üí ice in freezer)</li>
          <li><strong>Condensation</strong>: Gas ‚Üí Liquid (e.g., droplets on cold bottle)</li>
        </ul>

        <h3>üîÑ Reversible vs. Irreversible Changes</h3>
        <p>Most state changes are <strong>reversible</strong>:</p>
        <ul>
          <li>Water ‚áÑ Ice ‚áÑ Steam</li>
        </ul>
        <p>But some changes caused by heat are <strong>irreversible</strong>:</p>
        <ul>
          <li>Burning wood ‚Üí ash (can‚Äôt reverse it!)</li>
          <li>Frying an egg ‚Üí cooked egg (can‚Äôt become raw again)</li>
        </ul>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: You dry fish in the sun for preservation. Is this change reversible? Why or why not?
        </blockquote>

        <h3>‚úÖ Exemplar Activity: Observe Your Home</h3>
        <p>Record 3 examples of heating/cooling effects you see daily:</p>
        <table>
          <thead>
            <tr><th>Material</th><th>Change Observed</th><th>Heating or Cooling?</th></tr>
          </thead>
          <tbody>
            <tr><td>Water</td><td>Turns to steam when boiled</td><td>Heating</td></tr>
            <tr><td>Maize</td><td>Dries in sun (water evaporates)</td><td>Heating</td></tr>
            <tr><td>Cold drink</td><td>Droplets form on outside</td><td>Cooling (condensation)</td></tr>
          </tbody>
        </table>

        <h3>üè° Real-Life Applications in Ghana</h3>
        <ul>
          <li><strong>Drying fish or maize</strong>: Uses evaporation to preserve food.</li>
          <li><strong>Refrigeration</strong>: Slows spoilage by cooling.</li>
          <li><strong>Cooking banku</strong>: Heat changes dough into soft, edible solid.</li>
          <li><strong>Morning dew</strong>: Water vapour condenses on cool grass.</li>
        </ul>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <ol>
            <li>What happens to ice when left in the sun? Name the process.</li>
            <li>Why do droplets form on the outside of a cold bottle?</li>
            <li>Is frying an egg a reversible change? Explain.</li>
            <li>How do Ghanaians use evaporation to preserve food?</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In the next unit, we‚Äôll explore mixtures‚Äîhow to separate sand from water, salt from seawater, and why some substances dissolve while others don‚Äôt.</p>
      </div>
      <!-- === END REPLACE SECTION === -->

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <!-- FOOTER -->
      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const currentChapter = 3;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Explain the effects of heating and cooling on materials",
        loTags: ["B7/JHS1.1.1.1.4"],
        objectives: [
          "Observe and describe how heating and cooling cause materials to change state (e.g., melting, freezing, evaporation, condensation).",
          "Explain why some changes are reversible and others are not.",
          "Apply knowledge of heating/cooling to real-life situations like cooking, food preservation, and weather.",
          "Record examples of state changes in your home or community."
        ],
        words: [
          "Melting", "Freezing", "Evaporation", "Condensation",
          "Boiling", "Reversible", "Heat energy", "State change"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>What happens to ice when left in the sun? Name the process.</li>
            <li>Why do droplets form on the outside of a cold bottle?</li>
            <li>Is frying an egg a reversible change? Explain.</li>
            <li>How do Ghanaians use evaporation to preserve food?</li>
          </ol>
          <p><em>Confirm your understanding before moving on.</em></p>
        `,
        nextPreview: "In the next unit, we‚Äôll explore mixtures‚Äîhow to separate sand from water, salt from seawater, and why some substances dissolve while others don‚Äôt.",
        assessmentItems: [
          { id: "1", prompt: "What is the process called when a solid turns into a liquid?", options: [
            {id:"a",text:"Freezing",is_correct:false},
            {id:"b",text:"Evaporation",is_correct:false},
            {id:"c",text:"Melting",is_correct:true},
            {id:"d",text:"Condensation",is_correct:false}
          ]},
          { id: "2", prompt: "Which process occurs when water vapour turns into liquid droplets on a cold surface?", options: [
            {id:"a",text:"Melting",is_correct:false},
            {id:"b",text:"Condensation",is_correct:true},
            {id:"c",text:"Boiling",is_correct:false},
            {id:"d",text:"Freezing",is_correct:false}
          ]},
          { id: "3", prompt: "What happens when you boil water?", options: [
            {id:"a",text:"It freezes",is_correct:false},
            {id:"b",text:"It melts",is_correct:false},
            {id:"c",text:"It evaporates rapidly",is_correct:true},
            {id:"d",text:"It becomes solid",is_correct:false}
          ]},
          { id: "4", prompt: "Which of these is a reversible change?", options: [
            {id:"a",text:"Burning paper",is_correct:false},
            {id:"b",text:"Melting ice",is_correct:true},
            {id:"c",text:"Frying an egg",is_correct:false},
            {id:"d",text:"Rusting iron",is_correct:false}
          ]},
          { id: "5", prompt: "How do Ghanaians commonly use evaporation to preserve food?", options: [
            {id:"a",text:"By freezing fish",is_correct:false},
            {id:"b",text:"By drying fish or maize in the sun",is_correct:true},
            {id:"c",text:"By adding sugar only",is_correct:false},
            {id:"d",text:"By storing in plastic bags",is_correct:false}
          ]},
          { id: "6", prompt: "What causes morning dew to form on grass?", options: [
            {id:"a",text:"Melting of frost",is_correct:false},
            {id:"b",text:"Condensation of water vapour in cool air",is_correct:true},
            {id:"c",text:"Rain falling lightly",is_correct:false},
            {id:"d",text:"Evaporation from soil",is_correct:false}
          ]},
          { id: "7", prompt: "Which change is caused by removing heat?", options: [
            {id:"a",text:"Melting butter",is_correct:false},
            {id:"b",text:"Boiling soup",is_correct:false},
            {id:"c",text:"Freezing water into ice",is_correct:true},
            {id:"d",text:"Drying clothes",is_correct:false}
          ]},
          { id: "8", prompt: "Why is frying an egg irreversible?", options: [
            {id:"a",text:"The eggshell breaks",is_correct:false},
            {id:"b",text:"Heat changes the protein structure permanently",is_correct:true},
            {id:"c",text:"It loses colour",is_correct:false},
            {id:"d",text:"It becomes lighter",is_correct:false}
          ]},
          { id: "9", prompt: "What happens to wet clothes hung in the sun?", options: [
            {id:"a",text:"They freeze",is_correct:false},
            {id:"b",text:"Water evaporates",is_correct:true},
            {id:"c",text:"They melt",is_correct:false},
            {id:"d",text:"They condense",is_correct:false}
          ]},
          { id: "10", prompt: "Which appliance uses cooling to slow down food spoilage?", options: [
            {id:"a",text:"Blender",is_correct:false},
            {id:"b",text:"Refrigerator",is_correct:true},
            {id:"c",text:"Toaster",is_correct:false},
            {id:"d",text:"Fan",is_correct:false}
          ]},
          { id: "11", prompt: "What is needed for boiling to occur?", options: [
            {id:"a",text:"Cooling",is_correct:false},
            {id:"b",text:"High pressure only",is_correct:false},
            {id:"c",text:"Addition of heat energy",is_correct:true},
            {id:"d",text:"Removal of air",is_correct:false}
          ]},
          { id: "12", prompt: "Which of these is NOT a state change?", options: [
            {id:"a",text:"Ice melting",is_correct:false},
            {id:"b",text:"Water boiling",is_correct:false},
            {id:"c",text:"Cutting paper",is_correct:true},
            {id:"d",text:"Steam condensing",is_correct:false}
          ]},
          { id: "13", prompt: "What happens to particles when a liquid is heated?", options: [
            {id:"a",text:"They slow down and pack tightly",is_correct:false},
            {id:"b",text:"They move faster and spread apart",is_correct:true},
            {id:"c",text:"They disappear",is_correct:false},
            {id:"d",text:"They turn into solids",is_correct:false}
          ]},
          { id: "14", prompt: "Why does a cold drink 'sweat' on a hot day?", options: [
            {id:"a",text:"The bottle is leaking",is_correct:false},
            {id:"b",text:"Water vapour in the air condenses on the cold surface",is_correct:true},
            {id:"c",text:"The drink is boiling",is_correct:false},
            {id:"d",text:"Ice is melting inside",is_correct:false}
          ]},
          { id: "15", prompt: "Which process is used to make ice cubes?", options: [
            {id:"a",text:"Melting",is_correct:false},
            {id:"b",text:"Freezing",is_correct:true},
            {id:"c",text:"Evaporation",is_correct:false},
            {id:"d",text:"Condensation",is_correct:false}
          ]},
          { id: "16", prompt: "What is 'heat energy'?", options: [
            {id:"a",text:"Energy that makes things colder",is_correct:false},
            {id:"b",text:"Energy transferred due to temperature difference, causing particles to move",is_correct:true},
            {id:"c",text:"Light from the sun only",is_correct:false},
            {id:"d",text:"Sound energy",is_correct:false}
          ]},
          { id: "17", prompt: "Which change is useful for preserving food in rural Ghana?", options: [
            {id:"a",text:"Melting",is_correct:false},
            {id:"b",text:"Freezing (where electricity exists)",is_correct:false},
            {id:"c",text:"Evaporation (sun-drying)",is_correct:true},
            {id:"d",text:"Condensation",is_correct:false}
          ]},
          { id: "18", prompt: "What happens when steam touches a cold mirror?", options: [
            {id:"a",text:"It melts",is_correct:false},
            {id:"b",text:"It freezes",is_correct:false},
            {id:"c",text:"It condenses into water droplets",is_correct:true},
            {id:"d",text:"It disappears",is_correct:false}
          ]},
          { id: "19", prompt: "Which statement about reversible changes is TRUE?", options: [
            {id:"a",text:"They cannot be undone",is_correct:false},
            {id:"b",text:"They involve chemical reactions only",is_correct:false},
            {id:"c",text:"State changes like melting and freezing can be reversed",is_correct:true},
            {id:"d",text:"Burning is reversible",is_correct:false}
          ]},
          { id: "20", prompt: "How does heating affect the volume of most liquids?", options: [
            {id:"a",text:"Volume decreases",is_correct:false},
            {id:"b",text:"Volume stays the same",is_correct:false},
            {id:"c",text:"Volume increases (expansion)",is_correct:true},
            {id:"d",text:"Volume turns to gas instantly",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
