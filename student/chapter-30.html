<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: How Light Behaves ‚Äî Straight Lines, Reflection, Refraction, and Rainbows">
  <title>Mini OpenStax ‚Äî How Light Behaves</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1.2rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
    .light-box {
      background: #f0f7f4;
      padding: 0.75rem;
      margin: 0.75rem 0;
      border-radius: 6px;
      border-left: 3px solid var(--green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">How Light Behaves</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.1.3.1</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò The Amazing Journey of Light</h2>
        <p>Light is a form of energy that behaves in predictable‚Äîand sometimes surprising‚Äîways. Understanding its properties helps explain everything from mirrors to rainbows!</p>

        <div class="light-box">
          <strong>1. Light Travels in Straight Lines</strong><br>
          ‚Üí This is why shadows have sharp edges.<br>
          ‚Üí If light bent around corners, shadows would be fuzzy or nonexistent.
        </div>

        <div class="light-box">
          <strong>2. Reflection</strong><br>
          ‚Üí Light bounces off smooth surfaces (like mirrors).<br>
          ‚Üí Angle of incidence = Angle of reflection.<br>
          ‚Üí Example: Seeing your face in a mirror.
        </div>

        <div class="light-box">
          <strong>3. Refraction</strong><br>
          ‚Üí Light bends when it passes from one medium to another (e.g., air ‚Üí water).<br>
          ‚Üí Causes objects underwater to look shifted or broken.<br>
          ‚Üí Example: A straw looks bent in a glass of water.
        </div>

        <div class="light-box">
          <strong>4. Dispersion</strong><br>
          ‚Üí White light splits into colours (ROYGBIV) when refracted.<br>
          ‚Üí Caused by different colours bending by different amounts.<br>
          ‚Üí Example: Rainbows after rain!
        </div>

        <table>
          <thead>
            <tr><th>Phenomenon</th><th>Real-Life Example</th></tr>
          </thead>
          <tbody>
            <tr><td>Straight-line travel</td><td>Sharp shadows at noon</td></tr>
            <tr><td>Reflection</td><td>Mirror, calm lake surface</td></tr>
            <tr><td>Refraction</td><td>Lens in glasses, fish appearing closer in water</td></tr>
            <tr><td>Dispersion</td><td>Rainbow, prism splitting sunlight</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Why can‚Äôt you see around corners? If light could bend easily, how would the world look different? How does a periscope use reflection to let submarines see above water?
        </blockquote>

        <div class="activity-card">
          <h3>‚úÖ Exemplar Activity (NaCCA-aligned)</h3>
          <p><strong>‚ÄúLight Explorer Kit‚Äù (No special tools needed!)</strong><br>
          1. <strong>Straight lines</strong>: Shine a flashlight through three aligned holes in cards. What happens if you move one card?<br>
          2. <strong>Reflection</strong>: Use a mirror to bounce light onto a wall. Change the angle‚Äîwhat do you notice?<br>
          3. <strong>Refraction</strong>: Place a pencil in a glass of water. Observe from the side.<br>
          4. <strong>Dispersion</strong>: On a sunny day, spray water mist with a bottle‚Äîlook for a rainbow!<br>
          Draw or describe what you observe for each.
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîö End of Strand</h3>
        <p>Congratulations! You‚Äôve completed the <strong>Forces and Energy</strong> strand. You now understand energy forms, heat transfer, and light behavior‚Äîkey ideas used in engineering, climate science, and technology!</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 30;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "How Light Behaves",
        loTags: ["B7/JHS1.4.1.3.1"],
        objectives: [
          "Demonstrate that light travels in straight lines.",
          "Explain and observe reflection and refraction of light.",
          "Describe how white light disperses into colours (rainbow effect).",
          "Relate light behaviors to everyday phenomena like mirrors, lenses, and rainbows."
        ],
        words: [
          "Reflection", "Refraction", "Dispersion", "Straight line", "Ray",
          "Mirror", "Prism", "Rainbow", "Medium", "Angle"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Why do shadows prove light travels in straight lines?</li>
            <li>What happens to light when it hits a mirror? Use the word ‚Äúreflection.‚Äù</li>
            <li>Why does a straw look bent in water? Explain using ‚Äúrefraction.‚Äù</li>
            <li>How is a rainbow formed? Mention ‚Äúdispersion‚Äù and ‚Äúwater droplets.‚Äù</li>
          </ol>
          <p><em>Confirm your understanding before finishing the strand.</em></p>
        `,
        nextPreview: "Congratulations! You‚Äôve completed the <strong>Forces and Energy</strong> strand. You now understand energy forms, heat transfer, and light behavior‚Äîkey ideas used in engineering, climate science, and technology!",
        assessmentItems: [
          { id: "1", prompt: "Light travels in:", options: [
            {id:"a",text:"Curved paths",is_correct:false},
            {id:"b",text:"Straight lines",is_correct:true},
            {id:"c",text:"Random directions",is_correct:false},
            {id:"d",text:"Only in vacuum",is_correct:false}
          ]},
          { id: "2", prompt: "A mirror works because of:", options: [
            {id:"a",text:"Refraction",is_correct:false},
            {id:"b",text:"Dispersion",is_correct:false},
            {id:"c",text:"Reflection",is_correct:true},
            {id:"d",text:"Absorption",is_correct:false}
          ]},
          { id: "3", prompt: "A straw looks bent in water due to:", options: [
            {id:"a",text:"Reflection",is_correct:false},
            {id:"b",text:"Refraction",is_correct:true},
            {id:"c",text:"Dispersion",is_correct:false},
            {id:"d",text:"Diffusion",is_correct:false}
          ]},
          { id: "4", prompt: "White light splitting into colours is called:", options: [
            {id:"a",text:"Reflection",is_correct:false},
            {id:"b",text:"Refraction",is_correct:false},
            {id:"c",text:"Dispersion",is_correct:true},
            {id:"d",text:"Diffraction",is_correct:false}
          ]},
          { id: "5", prompt: "Which phenomenon causes rainbows?", options: [
            {id:"a",text:"Reflection only",is_correct:false},
            {id:"b",text:"Refraction and dispersion in water droplets",is_correct:true},
            {id:"c",text:"Absorption of light",is_correct:false},
            {id:"d",text:"Scattering in air",is_correct:false}
          ]},
          { id: "6", prompt: "If light didn‚Äôt travel straight, you would:", options: [
            {id:"a",text:"See sharper shadows",is_correct:false},
            {id:"b",text:"Not see clear images in mirrors",is_correct:false},
            {id:"c",text:"See around corners",is_correct:true},
            {id:"d",text:"Need brighter bulbs",is_correct:false}
          ]},
          { id: "7", prompt: "The angle at which light hits a mirror equals the angle at which it:", options: [
            {id:"a",text:"Refracts",is_correct:false},
            {id:"b",text:"Disperses",is_correct:false},
            {id:"c",text:"Reflects",is_correct:true},
            {id:"d",text:"Absorbs",is_correct:false}
          ]},
          { id: "8", prompt: "Which object uses refraction to focus light?", options: [
            {id:"a",text:"Flat mirror",is_correct:false},
            {id:"b",text:"Magnifying glass",is_correct:true},
            {id:"c",text:"Aluminum foil",is_correct:false},
            {id:"d",text:"Black cloth",is_correct:false}
          ]},
          { id: "9", prompt: "ROYGBIV represents:", options: [
            {id:"a",text:"Types of mirrors",is_correct:false},
            {id:"b",text:"Colours of dispersed light",is_correct:true},
            {id:"c",text:"Heat transfer methods",is_correct:false},
            {id:"d",text:"Forms of energy",is_correct:false}
          ]},
          { id: "10", prompt: "Light slows down when entering:", options: [
            {id:"a",text:"Vacuum",is_correct:false},
            {id:"b",text:"Air",is_correct:false},
            {id:"c",text:"Water or glass",is_correct:true},
            {id:"d",text:"Space",is_correct:false}
          ]},
          { id: "11", prompt: "Which proves light travels straight?", options: [
            {id:"a",text:"Rainbow",is_correct:false},
            {id:"b",text:"Sharp shadow",is_correct:true},
            {id:"c",text:"Mirror image",is_correct:false},
            {id:"d",text:"Bent straw",is_correct:false}
          ]},
          { id: "12", prompt: "In dispersion, which colour bends the most?", options: [
            {id:"a",text:"Red",is_correct:false},
            {id:"b",text:"Green",is_correct:false},
            {id:"c",text:"Violet",is_correct:true},
            {id:"d",text:"Yellow",is_correct:false}
          ]},
          { id: "13", prompt: "Periscopes in submarines use:", options: [
            {id:"a",text:"Refraction",is_correct:false},
            {id:"b",text:"Two reflections",is_correct:true},
            {id:"c",text:"Dispersion",is_correct:false},
            {id:"d",text:"Absorption",is_correct:false}
          ]},
          { id: "14", prompt: "A fish underwater appears closer due to:", options: [
            {id:"a",text:"Reflection",is_correct:false},
            {id:"b",text:"Refraction",is_correct:true},
            {id:"c",text:"Dispersion",is_correct:false},
            {id:"d",text:"Diffusion",is_correct:false}
          ]},
          { id: "15", prompt: "Which material causes the most refraction?", options: [
            {id:"a",text:"Air",is_correct:false},
            {id:"b",text:"Water",is_correct:false},
            {id:"c",text:"Glass",is_correct:true},
            {id:"d",text:"Vacuum",is_correct:false}
          ]},
          { id: "16", prompt: "You see your face in still water because of:", options: [
            {id:"a",text:"Refraction",is_correct:false},
            {id:"b",text:"Reflection",is_correct:true},
            {id:"c",text:"Dispersion",is_correct:false},
            {id:"d",text:"Absorption",is_correct:false}
          ]},
          { id: "17", prompt: "Which is NOT a property of light?", options: [
            {id:"a",text:"Travels in straight lines",is_correct:false},
            {id:"b",text:"Can be reflected",is_correct:false},
            {id:"c",text:"Needs a medium to travel",is_correct:true},
            {id:"d",text:"Can be dispersed",is_correct:false}
          ]},
          { id: "18", prompt: "Sunlight is:", options: [
            {id:"a",text:"Only yellow light",is_correct:false},
            {id:"b",text:"White light (all colours combined)",is_correct:true},
            {id:"c",text:"Invisible",is_correct:false},
            {id:"d",text:"Made of sound waves",is_correct:false}
          ]},
          { id: "19", prompt: "When light enters a denser medium, it:", options: [
            {id:"a",text:"Speeds up and bends away",is_correct:false},
            {id:"b",text:"Slows down and bends toward the normal",is_correct:true},
            {id:"c",text:"Does not change",is_correct:false},
            {id:"d",text:"Disappears",is_correct:false}
          ]},
          { id: "20", prompt: "To see a rainbow, the sun must be:", options: [
            {id:"a",text:"Behind you",is_correct:true},
            {id:"b",text:"In front of you",is_correct:false},
            {id:"c",text:"Directly overhead",is_correct:false},
            {id:"d",text:"At night",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîö End of Strand</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
