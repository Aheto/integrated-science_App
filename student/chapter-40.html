<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Conserving Energy for Our Future ‚Äî Sustainable Choices for Ghana and Beyond">
  <title>Mini OpenStax ‚Äî Conserving Energy for Our Future</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
    .conservation-box {
      background: #f0f7f4;
      padding: 0.75rem;
      margin: 0.75rem 0;
      border-radius: 6px;
      border-left: 3px solid var(--green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Conserving Energy for Our Future</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.3.1.3</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò Why Conserve Energy?</h2>
        <p>Energy isn‚Äôt ‚Äúused up‚Äù‚Äîbut **useful energy** (like electricity or fuel) becomes **harder to access** once converted to waste heat. Conserving energy means:</p>
        <ul>
          <li>Reducing waste</li>
          <li>Protecting the environment</li>
          <li>Saving money</li>
          <li>Ensuring supply for future generations</li>
        </ul>

        <div class="conservation-box">
          <strong>At Home</strong><br>
          ‚Ä¢ Turn off lights when not in use<br>
          ‚Ä¢ Use LED bulbs instead of incandescent<br>
          ‚Ä¢ Unplug devices (‚Äúphantom load‚Äù wastes power!)<br>
          ‚Ä¢ Cook with lids to reduce heat loss
        </div>

        <div class="conservation-box">
          <strong>At School</strong><br>
          ‚Ä¢ Switch off fans and projectors after class<br>
          ‚Ä¢ Use natural light during the day<br>
          ‚Ä¢ Recycle paper and plastics (manufacturing uses energy!)
        </div>

        <div class="conservation-box">
          <strong>In Ghana</strong><br>
          ‚Ä¢ Invest in solar and hydro (renewables)<br>
          ‚Ä¢ Reduce reliance on imported fossil fuels<br>
          ‚Ä¢ Promote energy-efficient stoves to reduce deforestation
        </div>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: If every student in your school left one light on overnight, how much energy would be wasted in a week? How could your class lead a ‚ÄúSwitch Off‚Äù campaign?
        </blockquote>

        <div class="activity-card">
          <h3>‚úÖ NaCCA Exemplar Activity</h3>
          <p><strong>‚ÄúDesign an Energy Conservation Plan‚Äù</strong><br>
          In groups, choose ONE setting: home, school, or community.<br>
          1. Identify 3 sources of energy waste.<br>
          2. Propose 3 practical solutions.<br>
          3. Create a poster or short skit to promote your plan.<br>
          Present to the class‚Äîand share with your headteacher or parents!
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üéì Congratulations! You‚Äôve Completed Strand 4!</h3>
        <p>You now understand energy forms, electricity, conservation, and real-world applications. These skills are used by engineers, scientists, and responsible citizens worldwide. Keep exploring!</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Final Strand Quiz (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 40;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Conserving Energy for Our Future",
        loTags: ["B7/JHS1.4.3.1.3"],
        objectives: [
          "Explain why conserving useful energy matters for people and the planet.",
          "Identify common sources of energy waste at home, school, and in communities.",
          "Propose practical, sustainable solutions to reduce energy consumption.",
          "Advocate for energy conservation through creative communication."
        ],
        words: [
          "Conserve", "Waste", "Renewable", "Efficiency", "Sustainable",
          "Phantom load", "LED", "Campaign", "Deforestation", "Future"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Why is it important to conserve energy even though it‚Äôs never destroyed?</li>
            <li>Name three ways to save electricity at home.</li>
            <li>How does energy waste harm the environment?</li>
            <li>Design a slogan for a school energy conservation campaign.</li>
          </ol>
          <p><em>Confirm your understanding before celebrating your achievement!</em></p>
        `,
        nextPreview: "You now understand energy forms, electricity, conservation, and real-world applications. These skills are used by engineers, scientists, and responsible citizens worldwide. Keep exploring!",
        assessmentItems: [
          { id: "1", prompt: "We conserve energy mainly to:", options: [
            {id:"a",text:"Destroy less matter",is_correct:false},
            {id:"b",text:"Preserve useful forms and reduce waste",is_correct:true},
            {id:"c",text:"Stop all energy conversion",is_correct:false},
            {id:"d",text:"Make energy disappear",is_correct:false}
          ]},
          { id: "2", prompt: "Which saves the most electricity?", options: [
            {id:"a",text:"Leaving TV on standby",is_correct:false},
            {id:"b",text:"Using LED bulbs",is_correct:true},
            {id:"c",text:"Boiling excess water",is_correct:false},
            {id:"d",text:"Charging phones overnight",is_correct:false}
          ]},
          { id: "3", prompt: "‚ÄúPhantom load‚Äù refers to:", options: [
            {id:"a",text:"Energy used by unplugged devices",is_correct:false},
            {id:"b",text:"Energy wasted by devices on standby",is_correct:true},
            {id:"c",text:"Solar power at night",is_correct:false},
            {id:"d",text:"Battery storage",is_correct:false}
          ]},
          { id: "4", prompt: "Energy-efficient stoves help Ghana by:", options: [
            {id:"a",text:"Increasing charcoal use",is_correct:false},
            {id:"b",text:"Reducing deforestation",is_correct:true},
            {id:"c",text:"Using more kerosene",is_correct:false},
            {id:"d",text:"Generating nuclear waste",is_correct:false}
          ]},
          { id: "5", prompt: "Turning off lights when not needed is:", options: [
            {id:"a",text:"A conservation practice",is_correct:true},
            {id:"b",text:"A waste of time",is_correct:false},
            {id:"c",text:"Only for rich homes",is_correct:false},
            {id:"d",text:"Harmful to bulbs",is_correct:false}
          ]},
          { id: "6", prompt: "Renewable energy includes:", options: [
            {id:"a",text:"Coal",is_correct:false},
            {id:"b",text:"Oil",is_correct:false},
            {id:"c",text:"Solar and hydro",is_correct:true},
            {id:"d",text:"Natural gas",is_correct:false}
          ]},
          { id: "7", prompt: "At school, you can conserve energy by:", options: [
            {id:"a",text:"Leaving fans on after class",is_correct:false},
            {id:"b",text:"Using natural light when possible",is_correct:true},
            {id:"c",text:"Printing extra copies",is_correct:false},
            {id:"d",text:"Running AC all day",is_correct:false}
          ]},
          { id: "8", prompt: "Conserving energy helps the environment by:", options: [
            {id:"a",text:"Increasing pollution",is_correct:false},
            {id:"b",text:"Reducing greenhouse gas emissions",is_correct:true},
            {id:"c",text:"Using more plastic",is_correct:false},
            {id:"d",text:"Cutting down more trees",is_correct:false}
          ]},
          { id: "9", prompt: "Cooking with a lid on the pot:", options: [
            {id:"a",text:"Wastes heat",is_correct:false},
            {id:"b",text:"Traps heat and saves energy",is_correct:true},
            {id:"c",text:"Makes food burn",is_correct:false},
            {id:"d",text:"Uses more gas",is_correct:false}
          ]},
          { id: "10", prompt: "Unplugging chargers when not in use:", options: [
            {id:"a",text:"Has no effect",is_correct:false},
            {id:"b",text:"Reduces phantom load",is_correct:true},
            {id:"c",text:"Damages outlets",is_correct:false},
            {id:"d",text:"Increases bills",is_correct:false}
          ]},
          { id: "11", prompt: "The Law of Conservation of Energy means:", options: [
            {id:"a",text:"Useful energy can become waste heat",is_correct:true},
            {id:"b",text:"Energy vanishes when used",is_correct:false},
            {id:"c",text:"Only machines conserve energy",is_correct:false},
            {id:"d",text:"Humans don‚Äôt follow physics",is_correct:false}
          ]},
          { id: "12", prompt: "An energy conservation campaign should:", options: [
            {id:"a",text:"Blame others",is_correct:false},
            {id:"b",text:"Educate and inspire action",is_correct:true},
            {id:"c",text:"Ignore facts",is_correct:false},
            {id:"d",text:"Promote waste",is_correct:false}
          ]},
          { id: "13", prompt: "Recycling paper conserves energy because:", options: [
            {id:"a",text:"Making new paper uses lots of energy",is_correct:true},
            {id:"b",text:"Paper can‚Äôt be reused",is_correct:false},
            {id:"c",text:"It creates more trash",is_correct:false},
            {id:"d",text:"It‚Äôs only for schools",is_correct:false}
          ]},
          { id: "14", prompt: "Ghana‚Äôs main renewable source is:", options: [
            {id:"a",text:"Coal",is_correct:false},
            {id:"b",text:"Hydroelectric power",is_correct:true},
            {id:"c",text:"Nuclear",is_correct:false},
            {id:"d",text:"Natural gas",is_correct:false}
          ]},
          { id: "15", prompt: "Energy conservation is a form of:", options: [
            {id:"a",text:"Wastefulness",is_correct:false},
            {id:"b",text:"Environmental stewardship",is_correct:true},
            {id:"c",text:"Ignorance",is_correct:false},
            {id:"d",text:"Luxury",is_correct:false}
          ]},
          { id: "16", prompt: "Which is NOT a conservation method?", options: [
            {id:"a",text:"Using energy-efficient appliances",is_correct:false},
            {id:"b",text:"Leaving taps running",is_correct:true},
            {id:"c",text:"Insulating homes",is_correct:false},
            {id:"d",text:"Walking instead of driving short distances",is_correct:false}
          ]},
          { id: "17", prompt: "Conserving energy benefits:", options: [
            {id:"a",text:"Only rich people",is_correct:false},
            {id:"b",text:"Humans, animals, and ecosystems",is_correct:true},
            {id:"c",text:"Only factories",is_correct:false},
            {id:"d",text:"No one",is_correct:false}
          ]},
          { id: "18", prompt: "A student can lead change by:", options: [
            {id:"a",text:"Ignoring science",is_correct:false},
            {id:"b",text:"Starting a school conservation club",is_correct:true},
            {id:"c",text:"Wasting resources",is_correct:false},
            {id:"d",text:"Copying others",is_correct:false}
          ]},
          { id: "19", prompt: "Understanding energy empowers you to:", options: [
            {id:"a",text:"Make informed, sustainable choices",is_correct:true},
            {id:"b",text:"Believe myths",is_correct:false},
            {id:"c",text:"Avoid technology",is_correct:false},
            {id:"d",text:"Depend on others always",is_correct:false}
          ]},
          { id: "20", prompt: "Completing Strand 4 means you can:", options: [
            {id:"a",text:"Explain, apply, and advocate for energy science",is_correct:true},
            {id:"b",text:"Only pass exams",is_correct:false},
            {id:"c",text:"Forget everything",is_correct:false},
            {id:"d",text:"Ignore the environment",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üéì Congratulations! You‚Äôve Completed Strand 4!</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
