<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: Safe Handling and Maintenance of Agricultural Tools">
  <title>Mini OpenStax ‚Äî Safe Handling and Maintenance of Agricultural Tools</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
    .tool-box {
      background: #f0f7f4;
      padding: 0.75rem;
      margin: 0.75rem 0;
      border-radius: 6px;
      border-left: 3px solid var(--green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">Safe Handling and Maintenance of Agricultural Tools</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.5.1.1‚Äì1.2</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò Respect Your Tools‚ÄîThey Feed the Nation!</h2>
        <p>Agricultural tools are not just metal‚Äîthey are extensions of human effort, rooted in Ghanaian culture and essential to food security. Handling them safely and maintaining them properly shows **respect, responsibility, and scientific understanding**.</p>

        <div class="tool-box">
          <strong>Common Farm Tools</strong><br>
          ‚Ä¢ <strong>Cutlass</strong>: for clearing brush<br>
          ‚Ä¢ <strong>Hoe</strong>: for tilling soil<br>
          ‚Ä¢ <strong>Rake</strong>: for gathering leaves or leveling soil<br>
          ‚Ä¢ <strong>Shovel</strong>: for digging and moving soil<br>
          ‚Ä¢ <strong>Wheelbarrow</strong>: for transporting crops or compost
        </div>

        <h3>Basic Safety Rules</h3>
        <ul>
          <li>Always carry sharp tools with the blade facing down and away from your body.</li>
          <li>Never swing a tool near others‚Äîannounce your actions clearly.</li>
          <li>Use tools only for their intended purpose (e.g., don‚Äôt use a hoe as a hammer).</li>
          <li>Store tools in a dry, secure place‚Äîout of reach of young children.</li>
        </ul>

        <h3>Maintenance Practices</h3>
        <table>
          <thead>
            <tr><th>Practice</th><th>Why It Matters</th></tr>
          </thead>
          <tbody>
            <tr><td>Clean after use</td><td>Removes soil, plant sap, and moisture that cause rust</td></tr>
            <tr><td>Dry thoroughly</td><td>Prevents corrosion and extends tool life</td></tr>
            <tr><td>Sharpen blades</td><td>Reduces effort and improves efficiency (sharp wedge = more pressure!)</td></tr>
            <tr><td>Oil metal parts</td><td>Reduces friction and prevents rust</td></tr>
            <tr><td>Check handles</td><td>Replace cracked or loose handles to prevent accidents</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: Why do elders say, ‚ÄúA farmer who neglects his tools will harvest hunger‚Äù? How does proper tool care connect to physics, safety, and cultural values?
        </blockquote>

        <div class="activity-card">
          <h3>‚úÖ NaCCA-Aligned Community Activity</h3>
          <p><strong>‚ÄúTool Care Demonstration‚Äù</strong><br>
          In groups:<br>
          1. Borrow or bring one clean farm tool (e.g., hoe, cutlass).<br>
          2. Demonstrate safe carrying, using, and storing.<br>
          3. Show how to clean, sharpen, and oil it.<br>
          4. Create a poster titled: ‚ÄúRespect the Tool, Respect the Land.‚Äù<br>
          Present to your class‚Äîand share with your family!
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 51, you‚Äôll apply these skills in a real farm setting‚Äîand reflect on how caring for tools supports sustainable agriculture and community well-being!</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 50;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "Safe Handling and Maintenance of Agricultural Tools",
        loTags: ["B7/JHS1.4.5.1.1‚Äì1.2"],
        objectives: [
          "Identify common agricultural tools and their uses.",
          "Explain safety rules for handling sharp and heavy tools.",
          "Demonstrate proper cleaning, sharpening, and storage practices.",
          "Connect tool care to physics, sustainability, and cultural values."
        ],
        words: [
          "Cutlass", "Hoe", "Maintenance", "Rust", "Sharpen",
          "Safety", "Handle", "Corrosion", "Efficiency", "Cultural respect"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Name three farm tools and their uses.</li>
            <li>Why should you always carry a cutlass with the blade down?</li>
            <li>List three steps to maintain a metal hoe.</li>
            <li>How does a sharp blade reduce the force needed to cut? (Hint: think wedges!)</li>
          </ol>
          <p><em>Confirm your understanding before the community application!</em></p>
        `,
        nextPreview: "In Lesson 51, you‚Äôll apply these skills in a real farm setting‚Äîand reflect on how caring for tools supports sustainable agriculture and community well-being!",
        assessmentItems: [
          { id: "1", prompt: "A cutlass should be carried:", options: [
            {id:"a",text:"Blade up, over shoulder",is_correct:false},
            {id:"b",text:"Blade down, away from body",is_correct:true},
            {id:"c",text:"Swinging freely",is_correct:false},
            {id:"d",text:"In a plastic bag",is_correct:false}
          ]},
          { id: "2", prompt: "Cleaning tools after use prevents:", options: [
            {id:"a",text:"Magnetism",is_correct:false},
            {id:"b",text:"Rust and corrosion",is_correct:true},
            {id:"c",text:"Overheating",is_correct:false},
            {id:"d",text:"Static electricity",is_correct:false}
          ]},
          { id: "3", prompt: "Sharpening a hoe improves:", options: [
            {id:"a",text:"Its color",is_correct:false},
            {id:"b",text:"Mechanical advantage (wedge efficiency)",is_correct:true},
            {id:"c",text:"Its weight",is_correct:false},
            {id:"d",text:"Its magnetic properties",is_correct:false}
          ]},
          { id: "4", prompt: "Oiling metal parts:", options: [
            {id:"a",text:"Increases rust",is_correct:false},
            {id:"b",text:"Reduces friction and prevents rust",is_correct:true},
            {id:"c",text:"Makes tools slippery to hold",is_correct:false},
            {id:"d",text:"Is only for engines",is_correct:false}
          ]},
          { id: "5", prompt: "Using a hoe as a hammer is:", options: [
            {id:"a",text:"Safe if done carefully",is_correct:false},
            {id:"b",text:"Acceptable in emergencies",is_correct:false},
            {id:"c",text:"Unsafe‚Äîtools have specific purposes",is_correct:true},
            {id:"d",text:"Recommended by farmers",is_correct:false}
          ]},
          { id: "6", prompt: "Loose or cracked handles should be:", options: [
            {id:"a",text:"Ignored if the blade is sharp",is_correct:false},
            {id:"b",text:"Replaced immediately",is_correct:true},
            {id:"c",text:"Tied with rope forever",is_correct:false},
            {id:"d",text:"Used only by adults",is_correct:false}
          ]},
          { id: "7", prompt: "Storing tools in a dry place prevents:", options: [
            {id:"a",text:"Theft only",is_correct:false},
            {id:"b",text:"Rust and deterioration",is_correct:true},
            {id:"c",text:"Magnetism",is_correct:false},
            {id:"d",text:"Light reflection",is_correct:false}
          ]},
          { id: "8", prompt: "Announcing your actions when using tools:", options: [
            {id:"a",text:"Slows you down",is_correct:false},
            {id:"b",text:"Prevents accidents and shows respect",is_correct:true},
            {id:"c",text:"Is only for teachers",is_correct:false},
            {id:"d",text:"Wastes time",is_correct:false}
          ]},
          { id: "9", prompt: "A dull cutlass requires:", options: [
            {id:"a",text:"Less force",is_correct:false},
            {id:"b",text:"More force and causes fatigue",is_correct:true},
            {id:"c",text:"No force",is_correct:false},
            {id:"d",text:"Only water",is_correct:false}
          ]},
          { id: "10", prompt: "Proper tool maintenance reflects:", options: [
            {id:"a",text:"Disrespect for tradition",is_correct:false},
            {id:"b",text:"Responsibility, safety, and cultural values",is_correct:true},
            {id:"c",text:"Waste of time",is_correct:false},
            {id:"d",text:"Modern laziness",is_correct:false}
          ]},
          { id: "11", prompt: "Which tool is used for tilling soil?", options: [
            {id:"a",text:"Rake",is_correct:false},
            {id:"b",text:"Hoe",is_correct:true},
            {id:"c",text:"Wheelbarrow",is_correct:false},
            {id:"d",text:"Sickle",is_correct:false}
          ]},
          { id: "12", prompt: "Which tool transports loads?", options: [
            {id:"a",text:"Cutlass",is_correct:false},
            {id:"b",text:"Hoe",is_correct:false},
            {id:"c",text:"Wheelbarrow",is_correct:true},
            {id:"d",text:"Shovel",is_correct:false}
          ]},
          { id: "13", prompt: "Rust is caused by:", options: [
            {id:"a",text:"Dry air",is_correct:false},
            {id:"b",text:"Moisture and oxygen",is_correct:true},
            {id:"c",text:"Sunlight only",is_correct:false},
            {id:"d",text:"Cold temperatures",is_correct:false}
          ]},
          { id: "14", prompt: "Sharpening increases pressure because:", options: [
            {id:"a",text:"Force is spread over larger area",is_correct:false},
            {id:"b",text:"Force is concentrated on smaller area",is_correct:true},
            {id:"c",text:"Weight increases",is_correct:false},
            {id:"d",text:"Friction disappears",is_correct:false}
          ]},
          { id: "15", prompt: "Community tool care supports:", options: [
            {id:"a",text:"Food security and sustainability",is_correct:true},
            {id:"b",text:"Individual competition",is_correct:false},
            {id:"c",text:"Tool waste",is_correct:false},
            {id:"d",text:"Ignoring elders",is_correct:false}
          ]},
          { id: "16", prompt: "Cultural identity in farming includes:", options: [
            {id:"a",text:"Discarding old tools",is_correct:false},
            {id:"b",text:"Respecting traditional knowledge and care practices",is_correct:true},
            {id:"c",text:"Using only tractors",is_correct:false},
            {id:"d",text:"Avoiding maintenance",is_correct:false}
          ]},
          { id: "17", prompt: "Physics connects to farming through:", options: [
            {id:"a",text:"Levers, wedges, and friction",is_correct:true},
            {id:"b",text:"Only electricity",is_correct:false},
            {id:"c",text:"Ignoring forces",is_correct:false},
            {id:"d",text:"Magic",is_correct:false}
          ]},
          { id: "18", prompt: "A well-maintained tool is:", options: [
            {id:"a",text:"Safer, more efficient, and lasts longer",is_correct:true},
            {id:"b",text:"Heavier",is_correct:false},
            {id:"c",text:"More expensive to replace",is_correct:false},
            {id:"d",text:"Harder to use",is_correct:false}
          ]},
          { id: "19", prompt: "The next lesson focuses on:", options: [
            {id:"a",text:"Applying tool care in a real farm setting",is_correct:true},
            {id:"b",text:"Only circuits",is_correct:false},
            {id:"c",text:"Avoiding science",is_correct:false},
            {id:"d",text:"Nuclear weapons",is_correct:false}
          ]},
          { id: "20", prompt: "Caring for tools shows:", options: [
            {id:"a",text:"Respect for work, land, and community",is_correct:true},
            {id:"b",text:"Laziness",is_correct:false},
            {id:"c",text:"Disinterest in farming",is_correct:false},
            {id:"d",text:"Preference for machines only",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
