<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <meta name="description" content="Mini OpenStax: From Farm Tools to Clean Communities ‚Äî Our Environmental Responsibility">
  <title>Mini OpenStax ‚Äî From Farm Tools to Clean Communities</title>
  <style>
    :root {
      --green: #006b3d;
      --gold: #cead00;
      --light: #f9f9f9;
      --dark: #2d2d2d;
    }
    body { 
      font-family: 'Segoe UI', system-ui, sans-serif; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      color: var(--dark); 
      line-height: 1.6;
    }
    .container { 
      max-width: 800px; 
      margin: 0 auto; 
      padding: 1rem; 
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      margin-bottom: 1rem; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
    }
    .role-badge { 
      background: #e9ecef; 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-size: 0.85rem; 
    }
    .chapter-nav { 
      margin: 1.2rem 0; 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.4rem; 
      justify-content: center; 
    }
    .chapter-btn {
      padding: 0.4rem 0.8rem; 
      background: var(--green); 
      color: white; 
      text-decoration: none; 
      border-radius: 4px; 
      font-size: 0.9rem;
    }
    .chapter-btn.active, .chapter-btn:hover { 
      background: #00502e; 
    }
    .section { 
      margin-bottom: 1.5rem; 
      padding-bottom: 1rem;
      border-bottom: 1px solid #eee;
    }
    .word-list { 
      display: flex; 
      flex-wrap: wrap; 
      gap: 0.5rem; 
      margin: 0.5rem 0; 
    }
    .word-item { 
      background: var(--light); 
      padding: 0.25rem 0.5rem; 
      border-radius: 4px; 
      font-family: monospace; 
      font-size: 0.95rem;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin: 1rem 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 0.5rem;
      text-align: left;
    }
    th {
      background-color: #f0f7f4;
    }
    .checkpoint, .thought-experiment {
      background: #f8f9fa;
      padding: 1rem;
      border-left: 4px solid var(--gold);
      margin: 1.5rem 0;
    }
    .quiz { 
      margin-top: 2rem; 
    }
    .question { 
      margin-bottom: 1.2rem; 
    }
    .options { 
      margin-left: 1rem; 
    }
    .option { 
      margin: 0.4rem 0; 
    }
    .btn {
      background: var(--green); 
      color: white; 
      border: none; 
      padding: 0.5rem 1rem;
      border-radius: 4px; 
      cursor: pointer; 
      font-size: 1rem; 
      margin-right: 0.5rem;
      display: inline-block;
    }
    .btn:hover { 
      background: #00502e; 
    }
    .btn-secondary { 
      background: #6c757d; 
    }
    .btn-secondary:hover { 
      background: #5a6268; 
    }
    .feedback { 
      margin-top: 1.5rem; 
      padding: 1rem; 
      background: var(--light); 
      border-left: 4px solid var(--green); 
    }
    footer { 
      text-align: center; 
      margin-top: 2rem; 
      font-size: 0.9rem; 
      padding-top: 1.5rem;
      border-top: 1px solid #eee;
    }
    a { 
      color: var(--green); 
      text-decoration: none; 
    }
    a:hover { 
      text-decoration: underline; 
    }
    blockquote {
      margin: 1rem 0;
      padding-left: 1rem;
      border-left: 3px solid var(--green);
      color: #555;
      font-style: italic;
    }
    .activity-card, .review-card {
      background: #f8f9fa;
      padding: 1rem;
      margin: 1rem 0;
      border-radius: 6px;
      border-left: 4px solid var(--green);
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <div>
        <h1 id="chapter-title">From Farm Tools to Clean Communities</h1>
        <div class="lo-tags" id="lo-tags">B7/JHS1.4.5 ‚Üí B7/JHS1.5.1</div>
      </div>
      <div class="role-badge">Student View</div>
    </div>

    <nav class="chapter-nav" id="chapter-nav"></nav>

    <main id="main-content">
      <div class="section">
        <h2>üéØ What You‚Äôll Learn</h2>
        <ul id="objectives">
          <!-- Filled by JS -->
        </ul>
      </div>

      <div class="section">
        <h2>üî§ Important Words</h2>
        <p id="word-list-desc">Key terms for this lesson:</p>
        <div class="word-list" id="word-list">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="lesson-content">
        <h2>üìò Caring for Tools, Caring for the Earth</h2>
        <p>You‚Äôve learned to care for hoes, cutlasses, and wheelbarrows. But what happens to **oil rags, broken handles, plastic seed bags, or chemical containers** after use?</p>
        <p>Every tool and material we use creates **waste**‚Äîand how we manage it affects our health, farms, rivers, and future.</p>

        <table>
          <thead>
            <tr><th>Farm Activity</th><th>Potential Waste</th><th>Environmental Risk if Mismanaged</th></tr>
          </thead>
          <tbody>
            <tr><td>Tool maintenance</td><td>Oily rags, metal scraps</td><td>Soil/water pollution</td></tr>
            <tr><td>Seed planting</td><td>Plastic packets, string</td><td>Litter, animal ingestion</td></tr>
            <tr><td>Harvesting</td><td>Rotten produce, packaging</td><td>Methane gas, pests</td></tr>
            <tr><td>Chemical use</td><td>Empty pesticide bottles</td><td>Toxic contamination</td></tr>
          </tbody>
        </table>

        <blockquote>
          üí≠ <strong>Thought Experiment</strong>: If every farmer in your community threw used oil or plastic on the ground, what would happen to the soil? The water? The crops? How can science help us break this cycle?
        </blockquote>

        <div class="review-card">
          <h3>‚úÖ Sub-strand 5 Review: Quick Recall</h3>
          <ul>
            <li>Tools must be cleaned, dried, sharpened, and stored safely.</li>
            <li>Respect for tools reflects cultural values and scientific understanding.</li>
            <li>Well-maintained tools reduce waste and improve efficiency.</li>
            <li>Now, we extend care from tools to the entire environment.</li>
          </ul>
        </div>

        <div class="activity-card">
          <h3>‚úÖ Bridge Activity</h3>
          <p><strong>‚ÄúWaste Audit Walk‚Äù</strong><br>
          With teacher or parent permission:<br>
          1. Walk around your school farm, home garden, or local field.<br>
          2. Record all types of waste you see (plastic, metal, organic, chemical).<br>
          3. Classify each as <em>biodegradable</em> or <em>non-biodegradable</em>.<br>
          4. Propose one scientific way to manage each type.<br>
          Bring your findings to class for discussion!
        </div>
      </div>

      <div class="section">
        <h2>‚úÖ Check Your Understanding</h2>
        <div class="checkpoint" id="checkpoint-questions">
          <!-- Filled by JS -->
        </div>
      </div>

      <div class="section" id="next-preview">
        <h3>üîú Coming Up</h3>
        <p>In Lesson 53, you‚Äôll research and apply scientific waste management practices‚Äîand launch a community clean-up project to make your environment healthier!</p>
      </div>

      <div id="student-name-prompt" class="section" style="display:none;">
        <h2>üë§ Your Name</h2>
        <div id="name-display"></div>
        <input type="text" id="student-name" placeholder="Enter your name" maxlength="30"
          style="padding:0.5rem;font-size:1rem;width:100%;margin:0.5rem 0;display:none;">
        <div id="name-buttons"></div>
      </div>

      <div class="quiz" id="quiz-container" style="display:none;">
        <h2>üìù Quick Check (20 Questions)</h2>
        <p>Select the best answer for each question.</p>
        <form id="quiz-form"></form>
        <button type="button" class="btn" id="submit-quiz">Check Answers</button>
      </div>

      <div id="feedback"></div>

      <footer>
        <a href="../premium.html" style="display:block; margin-bottom:0.5rem;">‚ú® Unlock Premium Features</a>
        <a href="#" id="send-analytics" style="color:#6c757d;">üì§ Send Anonymous Usage Data</a>
        <br>
        <a href="../dashboard.html">üìä View Dashboard</a>
      </footer>
    </main>
  </div>

  <script>
    (function () {
      'use strict';
      window.startTime = Date.now();

      const currentChapter = 52;
      const MAX_CHAPTER = 300;
      const WHATSAPP_NUMBER = "233257320201";

      function createSeededRNG(seed) {
        let state = Math.abs((seed * 9301 + 49297) % 233280);
        return () => {
          state = (state * 9301 + 49297) % 233280;
          return state / 233280;
        };
      }

      function shuffleWithSeed(array, seed) {
        const rng = createSeededRNG(seed);
        const arr = [...array];
        for (let i = arr.length - 1; i > 0; i--) {
          const j = Math.floor(rng() * (i + 1));
          [arr[i], arr[j]] = [arr[j], arr[i]];
        }
        return arr;
      }

      const ANALYTICS_KEY = 'miniopenstax_analytics_consent';
      const EVENTS_KEY = 'miniopenstax_events';

      function isAnalyticsEnabled() {
        return localStorage.getItem(ANALYTICS_KEY) === '1';
      }

      function logEvent(eventType, data = {}) {
        if (!isAnalyticsEnabled()) return;
        const event = { type: eventType, timestamp: Date.now(), lesson: currentChapter, data };
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        events.push(event);
        localStorage.setItem(EVENTS_KEY, JSON.stringify(events));
        if (events.length >= 20) sendAnalyticsEvents();
      }

      function enableAnalytics() {
        localStorage.setItem(ANALYTICS_KEY, '1');
      }

      function sendAnalyticsEvents() {
        const events = JSON.parse(localStorage.getItem(EVENTS_KEY) || '[]');
        if (events.length === 0) return;
        const summary = {
          lessons_attempted: [...new Set(events.map(e => e.lesson))].length,
          quizzes_submitted: events.filter(e => e.type === 'quiz_submitted').length,
          mastery_count: events.filter(e => e.type === 'mastery_achieved').length,
          first_event: new Date(events[0].timestamp).toISOString().split('T')[0],
          last_event: new Date(events[events.length - 1].timestamp).toISOString().split('T')[0]
        };
        const report = `*Mini OpenStax ‚Äî Anonymous Usage Report*\n` +
          `Lessons Tried: ${summary.lessons_attempted}\n` +
          `Quizzes Taken: ${summary.quizzes_submitted}\n` +
          `Mastery Achieved: ${summary.mastery_count}\n` +
          `Period: ${summary.first_event} to ${summary.last_event}\n\n` +
          `Thank you for helping improve literacy tools!`;
        localStorage.removeItem(EVENTS_KEY);
        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        window.open(url, '_blank');
      }

      const CHAPTER_CONFIG = {
        title: "From Farm Tools to Clean Communities",
        loTags: ["B7/JHS1.4.5 ‚Üí B7/JHS1.5.1"],
        objectives: [
          "Connect agricultural tool use to environmental waste generation.",
          "Identify common farm-related wastes and their risks.",
          "Classify waste as biodegradable or non-biodegradable.",
          "Prepare for scientific waste management in Lesson 53."
        ],
        words: [
          "Waste", "Biodegradable", "Pollution", "Audit", "Environment",
          "Chemical container", "Plastic", "Organic", "Management", "Responsibility"
        ],
        wordListDesc: "Key terms for this lesson:",
        checkpointQuestions: `
          <ol>
            <li>Name three types of waste generated during farm tool maintenance.</li>
            <li>Why is an empty pesticide bottle dangerous if thrown in the bush?</li>
            <li>What is the difference between biodegradable and non-biodegradable waste?</li>
            <li>How does proper waste management honor the same values as tool care?</li>
          </ol>
          <p><em>Reflect before launching your clean-up project!</em></p>
        `,
        nextPreview: "In Lesson 53, you‚Äôll research and apply scientific waste management practices‚Äîand launch a community clean-up project to make your environment healthier!",
        assessmentItems: [
          { id: "1", prompt: "Used oil from tool maintenance can:", options: [
            {id:"a",text:"Improve soil fertility",is_correct:false},
            {id:"b",text:"Pollute soil and water",is_correct:true},
            {id:"c",text:"Help plants grow",is_correct:false},
            {id:"d",text:"Evaporate safely",is_correct:false}
          ]},
          { id: "2", prompt: "Plastic seed bags are:", options: [
            {id:"a",text:"Biodegradable",is_correct:false},
            {id:"b",text:"Non-biodegradable",is_correct:true},
            {id:"c",text:"Good compost",is_correct:false},
            {id:"d",text:"Edible by animals",is_correct:false}
          ]},
          { id: "3", prompt: "An empty pesticide bottle should be:", options: [
            {id:"a",text:"Buried or burned",is_correct:false},
            {id:"b",text:"Rinsed and disposed of through safe channels",is_correct:true},
            {id:"c",text:"Reused for water",is_correct:false},
            {id:"d",text:"Thrown in the river",is_correct:false}
          ]},
          { id: "4", prompt: "Biodegradable waste includes:", options: [
            {id:"a",text:"Plastic",is_correct:false},
            {id:"b",text:"Metal scraps",is_correct:false},
            {id:"c",text:"Rotten yam peels",is_correct:true},
            {id:"d",text:"Oil rags",is_correct:false}
          ]},
          { id: "5", prompt: "Non-biodegradable waste:", options: [
            {id:"a",text:"Breaks down quickly",is_correct:false},
            {id:"b",text:"Persists in the environment for years",is_correct:true},
            {id:"c",text:"Is good for soil",is_correct:false},
            {id:"d",text:"Composts easily",is_correct:false}
          ]},
          { id: "6", prompt: "Scientific waste management means:", options: [
            {id:"a",text:"Burning everything",is_correct:false},
            {id:"b",text:"Using knowledge to reduce harm and reuse resources",is_correct:true},
            {id:"c",text:"Ignoring small waste",is_correct:false},
            {id:"d",text:"Only government‚Äôs job",is_correct:false}
          ]},
          { id: "7", prompt: "Cultural respect for land includes:", options: [
            {id:"a",text:"Littering freely",is_correct:false},
            {id:"b",text:"Keeping farms and villages clean",is_correct:true},
            {id:"c",text:"Using more chemicals",is_correct:false},
            {id:"d",text:"Avoiding science",is_correct:false}
          ]},
          { id: "8", prompt: "A waste audit helps you:", options: [
            {id:"a",text:"Count only plastic",is_correct:false},
            {id:"b",text:"Identify waste types and plan solutions",is_correct:true},
            {id:"c",text:"Blame others",is_correct:false},
            {id:"d",text:"Ignore problems",is_correct:false}
          ]},
          { id: "9", prompt: "Improper waste disposal can cause:", options: [
            {id:"a",text:"Clean water",is_correct:false},
            {id:"b",text:"Healthy crops",is_correct:false},
            {id:"c",text:"Disease and pollution",is_correct:true},
            {id:"d",text:"More fish",is_correct:false}
          ]},
          { id: "10", prompt: "Connecting tool care to waste management shows:", options: [
            {id:"a",text:"Science is isolated",is_correct:false},
            {id:"b",text:"Responsibility extends from tools to environment",is_correct:true},
            {id:"c",text:"Farming doesn‚Äôt affect nature",is_correct:false},
            {id:"d",text:"Waste is unavoidable",is_correct:false}
          ]},
          { id: "11", prompt: "Organic farm waste can be managed by:", options: [
            {id:"a",text:"Composting",is_correct:true},
            {id:"b",text:"Burning in open air",is_correct:false},
            {id:"c",text:"Dumping in streams",is_correct:false},
            {id:"d",text:"Leaving in fields forever",is_correct:false}
          ]},
          { id: "12", prompt: "Which is biodegradable?", options: [
            {id:"a",text:"Banana peel",is_correct:true},
            {id:"b",text:"Plastic bag",is_correct:false},
            {id:"c",text:"Metal can",is_correct:false},
            {id:"d",text:"Glass bottle",is_correct:false}
          ]},
          { id: "13", prompt: "Which is non-biodegradable?", options: [
            {id:"a",text:"Wood",is_correct:false},
            {id:"b",text:"Paper",is_correct:false},
            {id:"c",text:"Aluminum foil",is_correct:true},
            {id:"d",text:"Eggshell",is_correct:false}
          ]},
          { id: "14", prompt: "Methane gas from rotting waste contributes to:", options: [
            {id:"a",text:"Clean air",is_correct:false},
            {id:"b",text:"Climate change",is_correct:true},
            {id:"c",text:"Better crops",is_correct:false},
            {id:"d",text:"Cooler weather",is_correct:false}
          ]},
          { id: "15", prompt: "Students can lead by:", options: [
            {id:"a",text:"Starting clean-up clubs",is_correct:true},
            {id:"b",text:"Littering secretly",is_correct:false},
            {id:"c",text:"Ignoring waste",is_correct:false},
            {id:"d",text:"Waiting for adults only",is_correct:false}
          ]},
          { id: "16", prompt: "Scientific thinking about waste involves:", options: [
            {id:"a",text:"Observing, classifying, and solving",is_correct:true},
            {id:"b",text:"Guessing randomly",is_correct:false},
            {id:"c",text:"Copying without understanding",is_correct:false},
            {id:"d",text:"Avoiding action",is_correct:false}
          ]},
          { id: "17", prompt: "Cultural identity includes:", options: [
            {id:"a",text:"Protecting ancestral land from pollution",is_correct:true},
            {id:"b",text:"Discarding traditions",is_correct:false},
            {id:"c",text:"Using more plastic",is_correct:false},
            {id:"d",text:"Ignoring elders",is_correct:false}
          ]},
          { id: "18", prompt: "The next strand is:", options: [
            {id:"a",text:"Humans and the Environment",is_correct:true},
            {id:"b",text:"Only electricity",is_correct:false},
            {id:"c",text:"Avoiding science",is_correct:false},
            {id:"d",text:"Nuclear weapons",is_correct:false}
          ]},
          { id: "19", prompt: "Waste management is part of:", options: [
            {id:"a",text:"Food security and health",is_correct:true},
            {id:"b",text:"Only city life",is_correct:false},
            {id:"c",text:"Ignoring farming",is_correct:false},
            {id:"d",text:"Modern laziness",is_correct:false}
          ]},
          { id: "20", prompt: "This lesson shows that:", options: [
            {id:"a",text:"Caring for tools naturally leads to caring for the environment",is_correct:true},
            {id:"b",text:"Farming has no waste",is_correct:false},
            {id:"c",text:"Science stops at the classroom",is_correct:false},
            {id:"d",text:"Waste is someone else‚Äôs problem",is_correct:false}
          ]}
        ]
      };

      function renderContent() {
        document.getElementById('chapter-title').textContent = CHAPTER_CONFIG.title;
        document.getElementById('lo-tags').textContent = CHAPTER_CONFIG.loTags[0];

        document.getElementById('objectives').innerHTML =
          CHAPTER_CONFIG.objectives.map(obj => `<li>${obj}</li>`).join('');

        document.getElementById('word-list-desc').textContent = CHAPTER_CONFIG.wordListDesc;
        document.getElementById('word-list').innerHTML =
          CHAPTER_CONFIG.words.map(w => `<span class="word-item">${w}</span>`).join('');

        document.getElementById('checkpoint-questions').innerHTML = CHAPTER_CONFIG.checkpointQuestions;

        document.getElementById('next-preview').innerHTML = `
          <h3>üîú Coming Up</h3>
          <p>${CHAPTER_CONFIG.nextPreview}</p>
        `;
      }

      function renderNavigation() {
        const nav = document.getElementById('chapter-nav');
        const buttons = [{ label: "Home", url: "../index.html", active: false }];
        for (let i = 0; i < 4; i++) {
          const c = currentChapter + i;
          const lessonNum = c + 1;
          if (c > MAX_CHAPTER) break;
          buttons.push({
            label: `Lesson ${lessonNum}`,
            url: `chapter-${c}.html`,
            active: i === 0
          });
        }
        nav.innerHTML = buttons.map(b =>
          `<a href="${b.url}" class="chapter-btn ${b.active ? 'active' : ''}">${b.label}</a>`
        ).join('');
      }

      function renderQuiz() {
        const form = document.getElementById('quiz-form');
        window.quizCorrectMap = {};
        const baseSeed = currentChapter * 1000000 + (Date.now() % 1000000);

        form.innerHTML = CHAPTER_CONFIG.assessmentItems.map(q => {
          const seed = baseSeed + parseInt(q.id, 10);
          const shuffledOpts = shuffleWithSeed([...q.options], seed);
          const correct = q.options.find(o => o.is_correct);
          window.quizCorrectMap[q.id] = correct.id;

          const optHtml = shuffledOpts.map((opt, idx) => {
            const letter = String.fromCharCode(65 + idx);
            return `<div class="option"><label><input type="radio" name="q${q.id}" value="${opt.id}" required> ${letter}. ${opt.text}</label></div>`;
          }).join('');

          return `<div class="question"><strong>${q.id}. ${q.prompt}</strong><div class="options">${optHtml}</div></div>`;
        }).join('');
      }

      function showFeedback(answers) {
        const items = CHAPTER_CONFIG.assessmentItems;
        let correctCount = 0, correctList = [], incorrectList = [];

        items.forEach((item, i) => {
          const ans = answers[i];
          const correctId = window.quizCorrectMap[item.id];
          const correctOpt = item.options.find(o => o.id === correctId);
          const isCorrect = ans === correctId;
          if (isCorrect) {
            correctCount++;
            correctList.push(`${item.id}. ${item.prompt} ‚Üí ‚úÖ ${correctOpt.text}`);
          } else {
            incorrectList.push(`${item.id}. ${item.prompt} ‚Üí ‚ùå Your answer: ${item.options.find(o => o.id === ans)?.text || '‚Äî'} | ‚úÖ ${correctOpt.text}`);
          }
        });

        const score = correctCount, total = 20, mastery = score >= 15;
        const timeOnTask = Math.floor((Date.now() - window.startTime) / 1000);
        const attempts = (parseInt(localStorage.getItem(`quiz_attempts_${currentChapter}`)) || 0) + 1;
        localStorage.setItem(`quiz_attempts_${currentChapter}`, attempts);
        localStorage.setItem(`mastery_${currentChapter}`, mastery ? '1' : '0');
        const studentName = localStorage.getItem('student_name') || '[Name]';

        logEvent('quiz_submitted', { score, time_sec: timeOnTask, mastery, attempts });
        if (mastery) logEvent('mastery_achieved', {});

        let report = `*Mini OpenStax ‚Äî ${CHAPTER_CONFIG.title}*\nStudent: ${studentName}\nScore: ${score}/${total} (${Math.round(score/total*100)}%) ‚Äî ${mastery ? '‚úÖ MASTERED' : '‚ùå Needs Review'}\nTime: ${timeOnTask}s | Attempts: ${attempts}\n\n`;
        if (correctList.length) report += `‚úÖ CORRECT (${correctList.length}):\n${correctList.join('\n')}\n\n`;
        if (incorrectList.length) report += `‚ùå INCORRECT (${incorrectList.length}):\n${incorrectList.join('\n')}\n\n`;
        report += `Report generated via Mini OpenStax.`;

        localStorage.setItem(`saved_report_${currentChapter}_${Date.now()}`, report);

        const url = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(report)}`;
        document.getElementById('feedback').innerHTML = `
          <div class="feedback">
            <h3>üìä Results: ${score}/${total}</h3>
            <p><strong>${mastery ? 'üéâ Excellent!' : score >= 10 ? 'Good!' : 'Keep practicing.'}</strong> ${
              mastery ? 'You‚Äôve mastered the concept!' :
              score >= 10 ? 'Review missed items.' : 'Practice this lesson again.'
            }</p>
            <p><strong>Time:</strong> ${timeOnTask}s | <strong>Attempts:</strong> ${attempts}</p>
            <a href="${url}" target="_blank" class="btn" style="background:#25D366;text-decoration:none;">
              üì≤ Send Report via WhatsApp
            </a>
          </div>
        `;
      }

      function setupQuizListeners() {
        document.getElementById('submit-quiz').addEventListener('click', () => {
          const form = document.getElementById('quiz-form');
          const answers = [];
          for (let i = 1; i <= 20; i++) {
            const el = form.querySelector(`input[name="q${i}"]:checked`);
            answers.push(el ? el.value : null);
          }
          if (answers.includes(null)) {
            alert("Please answer all questions.");
            return;
          }
          showFeedback(answers);
        });
      }

      function initNamePrompt() {
        const saved = localStorage.getItem('student_name');
        const savedRole = localStorage.getItem('user_role') || 'student';
        const promptDiv = document.getElementById('student-name-prompt');
        const quizDiv = document.getElementById('quiz-container');
        const display = document.getElementById('name-display');
        const input = document.getElementById('student-name');
        const buttons = document.getElementById('name-buttons');
        const roleBadge = document.querySelector('.role-badge');
        roleBadge.textContent = savedRole === 'instructor' ? 'Instructor View' : 'Student View';

        if (saved) {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.innerHTML = `<p><strong>Current name:</strong> ${saved} (${savedRole})</p>`;
          buttons.innerHTML = `
            <button type="button" class="btn" id="keep-btn">‚úÖ Keep This Name</button>
            <button type="button" class="btn btn-secondary" id="change-btn">‚úèÔ∏è Use a Different Name</button>
          `;
          document.getElementById('keep-btn').onclick = () => {
            promptDiv.style.display = 'none';
            quizDiv.style.display = 'block';
            logEvent('lesson_start', {});
          };
          document.getElementById('change-btn').onclick = () => {
            display.style.display = 'none';
            input.style.display = 'block';
            buttons.innerHTML = `
              <button type="button" class="btn" id="save-new">üíæ Save and Start Quiz</button>
              <div style="margin-top:1rem; font-size:0.9rem;">
                <label>
                  <input type="checkbox" id="teacher-mode"> 
                  I'm an instructor (analytics auto-enabled to improve lessons)
                </label>
              </div>
            `;
            input.value = '';
            input.focus();
            document.getElementById('save-new').onclick = () => {
              const name = input.value.trim();
              if (name) {
                localStorage.setItem('student_name', name);
                const isTeacher = document.getElementById('teacher-mode').checked;
                localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
                if (isTeacher) enableAnalytics();
                promptDiv.style.display = 'none';
                quizDiv.style.display = 'block';
                roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
                logEvent('lesson_start', {});
              } else {
                alert("Please enter your name.");
                input.focus();
              }
            };
          };
        } else {
          promptDiv.style.display = 'block';
          quizDiv.style.display = 'none';
          display.style.display = 'none';
          input.style.display = 'block';
          buttons.innerHTML = `
            <button type="button" class="btn" id="save-first">üíæ Save and Start Quiz</button>
            <div style="margin-top:1rem; font-size:0.9rem;">
              <label>
                <input type="checkbox" id="teacher-mode"> 
                I'm an instructor (analytics auto-enabled to improve lessons)
              </label>
            </div>
          `;
          document.getElementById('save-first').onclick = () => {
            const name = input.value.trim();
            if (name) {
              localStorage.setItem('student_name', name);
              const isTeacher = document.getElementById('teacher-mode').checked;
              localStorage.setItem('user_role', isTeacher ? 'instructor' : 'student');
              if (isTeacher) enableAnalytics();
              promptDiv.style.display = 'none';
              quizDiv.style.display = 'block';
              roleBadge.textContent = isTeacher ? 'Instructor View' : 'Student View';
              logEvent('lesson_start', {});
            } else {
              alert("Please enter your name.");
              input.focus();
            }
          };
        }
      }

      function init() {
        renderContent();
        renderNavigation();
        renderQuiz();
        setupQuizListeners();
        initNamePrompt();
      }

      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('send-analytics').onclick = (e) => {
          e.preventDefault();
          if (confirm('Send anonymous usage data to help improve Mini OpenStax?')) {
            sendAnalyticsEvents();
          }
        };
      });

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }
    })();
  </script>
</body>
</html>
